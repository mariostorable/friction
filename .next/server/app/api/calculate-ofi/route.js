"use strict";(()=>{var e={};e.id=83,e.ids=[83],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},2461:(e,t,o)=>{o.r(t),o.d(t,{headerHooks:()=>g,originalPathname:()=>y,patchFetch:()=>v,requestAsyncStorage:()=>_,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>m});var r={};o.r(r),o.d(r,{POST:()=>d});var a=o(95419),n=o(69108),s=o(99678),i=o(78070),c=o(57699),u=o(23950),l=o(7439);async function d(e){try{let t=(0,c.createRouteHandlerClient)({cookies:l.cookies}),{data:{user:o}}=await t.auth.getUser();if(!o)return i.Z.json({error:"Not authenticated"},{status:401});let{accountId:r}=await e.json();if(!r)return i.Z.json({error:"Account ID required"},{status:400});let a=new Date;a.setDate(a.getDate()-14);let{data:n}=await t.from("friction_cards").select("*").eq("account_id",r).eq("user_id",o.id).gte("created_at",a.toISOString());if(!n||0===n.length)return i.Z.json({message:"No friction data to calculate",ofi_score:0});let{count:s}=await t.from("raw_inputs").select("*",{count:"exact",head:!0}).eq("account_id",r).eq("user_id",o.id),d=n.filter(e=>e.severity>=4).length,h={1:1,2:2,3:4,4:8,5:16},_=n.reduce((e,t)=>e+(h[t.severity]||1),0),p=s||1,f=n.length/p*100,g=20*Math.log10(_+1),m=Math.min(2,Math.max(.5,f/5)),y=Math.min(20,2*d),v=Math.round(g*m+y);v=Math.min(100,Math.max(0,v));let x={};n.forEach(e=>{x[e.theme_key]||(x[e.theme_key]={count:0,totalSeverity:0}),x[e.theme_key].count++,x[e.theme_key].totalSeverity+=e.severity});let k=Object.entries(x).map(([e,t])=>({theme_key:e,count:t.count,avg_severity:Math.round(t.totalSeverity/t.count*10)/10})).sort((e,t)=>t.count-e.count).slice(0,5),{data:w}=await t.from("account_snapshots").select("ofi_score").eq("account_id",r).order("snapshot_date",{ascending:!1}).limit(1).single(),q="stable",S=0;w&&w.ofi_score>0&&((S=Math.round((v-w.ofi_score)/w.ofi_score*100))>15?q="worsening":S<-15&&(q="improving"));let j=new Date().toISOString().split("T")[0],M=(0,u.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});await M.from("account_snapshots").delete().eq("account_id",r).eq("snapshot_date",j),console.log(`OFI Calculation for account ${r}:`,{recentCards:n.length,highSeverityCount:d,totalCases:s,weightedScore:_,baseScore:g,frictionDensity:f.toFixed(2)+"%",densityMultiplier:m.toFixed(2),highSeverityBoost:y,finalOfiScore:v});let{data:O,error:b}=await t.from("account_snapshots").insert({account_id:r,snapshot_date:j,ofi_score:v,friction_card_count:n.length,high_severity_count:d,case_volume:s||0,top_themes:k,trend_vs_prior_period:S,trend_direction:q,score_breakdown:{severity_weighted:_,card_count:n.length,base_score:g,friction_density:f,density_multiplier:m,high_severity_boost:y}}).select().single();if(b)return console.error("Snapshot error:",b),i.Z.json({error:"Failed to create snapshot",details:b.message},{status:500});return i.Z.json({success:!0,ofi_score:v,friction_cards:n.length,high_severity:d,trend:q,top_themes:k})}catch(e){return console.error("OFI calculation error:",e),i.Z.json({error:"OFI calculation failed",details:e instanceof Error?e.message:"Unknown"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/calculate-ofi/route",pathname:"/api/calculate-ofi",filename:"route",bundlePath:"app/api/calculate-ofi/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/calculate-ofi/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:_,staticGenerationAsyncStorage:p,serverHooks:f,headerHooks:g,staticGenerationBailout:m}=h,y="/api/calculate-ofi/route";function v(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:p})}}};var t=require("../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[456,552,421],()=>o(2461));module.exports=r})();