"use strict";(()=>{var e={};e.id=83,e.ids=[83],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},2461:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>v,patchFetch:()=>y,requestAsyncStorage:()=>h,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>m});var o={};r.r(o),r.d(o,{POST:()=>d});var a=r(95419),s=r(69108),n=r(99678),i=r(78070),c=r(57699),u=r(23950),l=r(7439);async function d(e){try{let t=(0,c.createRouteHandlerClient)({cookies:l.cookies}),{data:{user:r}}=await t.auth.getUser();if(!r)return i.Z.json({error:"Not authenticated"},{status:401});let{accountId:o}=await e.json();if(!o)return i.Z.json({error:"Account ID required"},{status:400});let a=new Date;a.setDate(a.getDate()-14);let{data:s}=await t.from("friction_cards").select("*").eq("account_id",o).eq("user_id",r.id).gte("created_at",a.toISOString());if(!s||0===s.length)return i.Z.json({message:"No friction data to calculate",ofi_score:0});let n={1:.5,2:1,3:2,4:5,5:10},d=s.reduce((e,t)=>e+(n[t.severity]||1),0),p=Math.min(100,Math.round(2*d)),h=s.filter(e=>e.severity>=4).length,_={};s.forEach(e=>{_[e.theme_key]||(_[e.theme_key]={count:0,totalSeverity:0}),_[e.theme_key].count++,_[e.theme_key].totalSeverity+=e.severity});let f=Object.entries(_).map(([e,t])=>({theme_key:e,count:t.count,avg_severity:Math.round(t.totalSeverity/t.count*10)/10})).sort((e,t)=>t.count-e.count).slice(0,5),{data:g}=await t.from("account_snapshots").select("ofi_score").eq("account_id",o).order("snapshot_date",{ascending:!1}).limit(1).single(),m="stable",v=0;g&&g.ofi_score>0&&((v=Math.round((p-g.ofi_score)/g.ofi_score*100))>15?m="worsening":v<-15&&(m="improving"));let y=new Date().toISOString().split("T")[0],k=(0,u.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});await k.from("account_snapshots").delete().eq("account_id",o).eq("snapshot_date",y);let{data:x,error:w}=await t.from("account_snapshots").insert({account_id:o,snapshot_date:y,ofi_score:p,friction_card_count:s.length,high_severity_count:h,top_themes:f,trend_vs_prior_period:v,trend_direction:m,score_breakdown:{severity_weighted:d,card_count:s.length}}).select().single();if(w)return console.error("Snapshot error:",w),i.Z.json({error:"Failed to create snapshot",details:w.message},{status:500});return i.Z.json({success:!0,ofi_score:p,friction_cards:s.length,high_severity:h,trend:m,top_themes:f})}catch(e){return console.error("OFI calculation error:",e),i.Z.json({error:"OFI calculation failed",details:e instanceof Error?e.message:"Unknown"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/calculate-ofi/route",pathname:"/api/calculate-ofi",filename:"route",bundlePath:"app/api/calculate-ofi/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/calculate-ofi/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:_,serverHooks:f,headerHooks:g,staticGenerationBailout:m}=p,v="/api/calculate-ofi/route";function y(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:_})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[456,552,421],()=>r(2461));module.exports=o})();