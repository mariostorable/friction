"use strict";(()=>{var e={};e.id=83,e.ids=[83],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},2461:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>m,originalPathname:()=>y,patchFetch:()=>v,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>f,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>g});var o={};r.r(o),r.d(o,{POST:()=>d});var a=r(95419),s=r(69108),i=r(99678),n=r(78070),c=r(57699),u=r(23950),l=r(7439);async function d(e){try{let t=(0,c.createRouteHandlerClient)({cookies:l.cookies}),{data:{user:r}}=await t.auth.getUser();if(!r)return n.Z.json({error:"Not authenticated"},{status:401});let{accountId:o}=await e.json();if(!o)return n.Z.json({error:"Account ID required"},{status:400});let a=new Date;a.setDate(a.getDate()-14);let{data:s}=await t.from("friction_cards").select("*").eq("account_id",o).eq("user_id",r.id).gte("created_at",a.toISOString());if(!s||0===s.length)return n.Z.json({message:"No friction data to calculate",ofi_score:0});let{count:i}=await t.from("raw_inputs").select("*",{count:"exact",head:!0}).eq("account_id",o).eq("user_id",r.id),d=s.filter(e=>e.severity>=4).length,_=Array.from(new Set(s.map(e=>e.theme_key))),{data:h}=await t.from("theme_jira_links").select(`
        theme_key,
        jira_issues!inner(
          status,
          resolution_date
        )
      `).in("theme_key",_).eq("jira_issues.user_id",r.id),p={};h?.forEach(e=>{let t=e.theme_key,r=e.jira_issues;if(r.resolution_date)p[t]="resolved";else if(!p[t]||"open"===p[t]){let e=r.status?.toLowerCase()||"";e.includes("progress")||e.includes("development")||e.includes("review")?p[t]="in_progress":p[t]||(p[t]="open")}});let f={1:1,2:2,3:3,4:5,5:8},m={resolved:.2,in_progress:.5,open:1},g=s.reduce((e,t)=>{let r=f[t.severity]||1,o=m[p[t.theme_key]||"open"];return e+r*o},0),y=i||1,v=s.length/y*100,k=15*Math.log10(g+1),w=Math.min(1.5,Math.max(.5,v/5)),x=Math.min(15,1.5*d),j=Math.round(k*w+x);j=Math.min(100,Math.max(0,j));let q={};s.forEach(e=>{q[e.theme_key]||(q[e.theme_key]={count:0,totalSeverity:0}),q[e.theme_key].count++,q[e.theme_key].totalSeverity+=e.severity});let S=Object.entries(q).map(([e,t])=>({theme_key:e,count:t.count,avg_severity:Math.round(t.totalSeverity/t.count*10)/10})).sort((e,t)=>t.count-e.count).slice(0,5),{data:M}=await t.from("account_snapshots").select("ofi_score").eq("account_id",o).order("snapshot_date",{ascending:!1}).limit(1).single(),O="stable",b=0;M&&M.ofi_score>0&&((b=Math.round((j-M.ofi_score)/M.ofi_score*100))>15?O="worsening":b<-15&&(O="improving"));let E=new Date().toISOString().split("T")[0],A=(0,u.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});await A.from("account_snapshots").delete().eq("account_id",o).eq("snapshot_date",E),console.log(`OFI Calculation for account ${o}:`,{recentCards:s.length,highSeverityCount:d,totalCases:i,weightedScore:g,baseScore:k,frictionDensity:v.toFixed(2)+"%",densityMultiplier:w.toFixed(2),highSeverityBoost:x,finalOfiScore:j});let{data:C,error:F}=await t.from("account_snapshots").insert({account_id:o,snapshot_date:E,ofi_score:j,friction_card_count:s.length,high_severity_count:d,case_volume:i||0,top_themes:S,trend_vs_prior_period:b,trend_direction:O,score_breakdown:{severity_weighted:g,card_count:s.length,base_score:k,friction_density:v,density_multiplier:w,high_severity_boost:x}}).select().single();if(F)return console.error("Snapshot error:",F),n.Z.json({error:"Failed to create snapshot",details:F.message},{status:500});return n.Z.json({success:!0,ofi_score:j,friction_cards:s.length,high_severity:d,trend:O,top_themes:S})}catch(e){return console.error("OFI calculation error:",e),n.Z.json({error:"OFI calculation failed",details:e instanceof Error?e.message:"Unknown"},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/calculate-ofi/route",pathname:"/api/calculate-ofi",filename:"route",bundlePath:"app/api/calculate-ofi/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/calculate-ofi/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:p,serverHooks:f,headerHooks:m,staticGenerationBailout:g}=_,y="/api/calculate-ofi/route";function v(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:p})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[456,552,421],()=>r(2461));module.exports=o})();