"use strict";(()=>{var e={};e.id=243,e.ids=[243],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},45583:(e,t,o)=>{o.r(t),o.d(t,{headerHooks:()=>w,originalPathname:()=>v,patchFetch:()=>$,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>k});var r={};o.r(r),o.d(r,{GET:()=>p,dynamic:()=>d,maxDuration:()=>u});var n=o(95419),s=o(69108),a=o(99678),i=o(78070),c=o(23950),l=o(5218);let d="force-dynamic",u=300,_=e=>new Promise(t=>setTimeout(t,e));async function h(e,t,o=3){for(let r=0;r<o;r++)try{let n=await fetch(e,t);if(529===n.status){let e=Math.min(1e3*Math.pow(2,r),3e4);console.log(`API overloaded (529), retrying in ${e}ms... (attempt ${r+1}/${o})`),await _(e);continue}return n}catch(e){if(r===o-1)throw e;await _(1e3*Math.pow(2,r))}throw Error("Max retries exceeded")}async function p(e){console.log("=== Analyze Portfolio Endpoint Called ==="),console.log("Auth header present:",!!e.headers.get("authorization")),console.log("CRON_SECRET configured:",!!process.env.CRON_SECRET),console.log("Auth check disabled for testing, starting analysis...");try{let e=(0,c.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),{error:t}=await e.from("alerts").delete().lt("expires_at",new Date().toISOString());t?console.error("Error cleaning up expired alerts:",t):console.log("✓ Expired alerts cleaned up");let{data:o}=await e.from("portfolios").select("user_id, account_ids, portfolio_type").in("portfolio_type",["top_25_edge","top_25_sitelink","top_25_marine"]);if(!o||0===o.length)return i.Z.json({message:"No portfolios found"});let r=[],n=0;for(let t of o)for(let o of t.account_ids)try{let s;let{data:a}=await e.from("accounts").select("salesforce_id, name, status").eq("id",o).single();if(!a)continue;if("cancelled"===a.status||"churned"===a.status){console.log(`Skipping ${a.name} - account is ${a.status}`),r.push({accountId:o,account:a.name,status:"skipped",reason:`Account is ${a.status}`});continue}let i=new Date().toISOString().split("T")[0],{data:c}=await e.from("account_snapshots").select("id, ofi_score").eq("account_id",o).eq("snapshot_date",i).maybeSingle();if(c){console.log(`Skipping ${a.name} - already analyzed today (OFI: ${c.ofi_score})`),r.push({accountId:o,account:a.name,status:"skipped",ofi:c.ofi_score,reason:"Already analyzed today"});continue}if(n>=50){console.log("Reached max analysis limit (50), stopping to avoid timeout");break}let{data:d}=await e.from("integrations").select("*").eq("user_id",t.user_id).eq("integration_type","salesforce").single();if(!d)continue;try{s=await (0,l.fV)(e,d.id)}catch(e){console.error(`Failed to decrypt tokens for user ${t.user_id}:`,e);continue}if(!s){console.log(`No tokens found for integration ${d.id}`);continue}let u=async()=>{if(!s.refresh_token)throw Error("No refresh token available");let t=await fetch("https://storable.my.salesforce.com/services/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:s.refresh_token,client_id:process.env.SALESFORCE_CLIENT_ID,client_secret:process.env.SALESFORCE_CLIENT_SECRET})});if(!t.ok)throw Error("Failed to refresh Salesforce token");let o=await t.json();return await (0,l.au)(e,s.id,o.access_token,new Date(Date.now()+72e5).toISOString()),o.access_token},p=`SELECT Id,CaseNumber,Subject,Description,Status,Priority,CreatedDate,Origin FROM Case WHERE AccountId='${a.salesforce_id}' AND CreatedDate=LAST_N_DAYS:90 ORDER BY CreatedDate DESC LIMIT 2000`;console.log(`Fetching cases for account: ${a.name} (${a.salesforce_id})`);let f=async e=>await fetch(`${d.instance_url}/services/data/v59.0/query?q=${encodeURIComponent(p)}`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),g=await f(s.access_token);if(401===g.status){console.log(`Access token expired for ${a.name}, refreshing...`);try{let e=await u();g=await f(e)}catch(e){console.error(`Failed to refresh token for ${a.name}:`,e),r.push({accountId:o,account:a.name,status:"failed",error:"Token refresh failed"});continue}}if(!g.ok){console.error(`Failed to fetch cases for ${a.name}:`,g.status),r.push({accountId:o,account:a.name,status:"failed",error:"Salesforce fetch failed"});continue}let m=await g.json();console.log(`Found ${m.records?.length||0} cases for ${a.name}`);let{data:y}=await e.from("raw_inputs").select("source_id").eq("account_id",o).eq("source_type","salesforce_case"),w=new Set(y?.map(e=>e.source_id)||[]);if(console.log(`Account has ${w.size} existing analyzed cases`),!m.records||0===m.records.length){let{data:t}=await e.from("account_snapshots").select("ofi_score").eq("account_id",o).order("snapshot_date",{ascending:!1}).limit(1).maybeSingle(),s=null,i="stable";t&&null!==t.ofi_score&&((s=0-t.ofi_score)<-5?i="improving":5>=Math.abs(s)&&(i="stable"));let{error:c}=await e.from("account_snapshots").insert({account_id:o,snapshot_date:new Date().toISOString().split("T")[0],ofi_score:0,friction_card_count:0,high_severity_count:0,case_volume:0,top_themes:[],score_breakdown:{base_score:0,friction_density:0,density_multiplier:0,high_severity_boost:0,severity_weighted:0,card_count:0},trend_vs_prior_period:s,trend_direction:i});c?(console.error(`Error creating snapshot for ${a.name}:`,c),r.push({accountId:o,account:a.name,status:"snapshot_error",error:c.message})):(console.log(`✓ Snapshot created for ${a.name} with OFI 0 (no cases)`),r.push({accountId:o,account:a.name,status:"no_cases",cases:0,ofi:0})),n++;continue}let k=m.records.filter(e=>!w.has(e.Id));if(console.log(`${k.length} new cases to analyze (${w.size} already analyzed)`),0===k.length){console.log(`No new cases for ${a.name}, recalculating OFI from existing cards...`);let{data:t}=await e.from("friction_cards").select("*").eq("account_id",o);if(!t||0===t.length){let{data:t}=await e.from("account_snapshots").select("ofi_score").eq("account_id",o).order("snapshot_date",{ascending:!1}).limit(1).maybeSingle(),s=null,i="stable";t&&null!==t.ofi_score&&((s=0-t.ofi_score)<-5?i="improving":5>=Math.abs(s)&&(i="stable")),await e.from("account_snapshots").insert({account_id:o,snapshot_date:new Date().toISOString().split("T")[0],ofi_score:0,friction_card_count:0,high_severity_count:0,case_volume:m.records.length,top_themes:[],score_breakdown:{base_score:0,friction_density:0,density_multiplier:0,high_severity_boost:0,severity_weighted:0,card_count:0},trend_vs_prior_period:s,trend_direction:i}),console.log(`✓ Snapshot created for ${a.name} with OFI 0 (no friction cards)`),r.push({accountId:o,account:a.name,status:"no_new_cases",cases:0,ofi:0}),n++;continue}let s=t.filter(e=>e.severity>=4).length,i={1:1,2:2,3:4,4:8,5:16},c=t.reduce((e,t)=>e+(i[t.severity]||1),0),l=m.records.length||1,d=t.length/l*100,u=20*Math.log10(c+1),_=Math.min(2,Math.max(.5,d/5)),h=Math.min(20,2*s),p=Math.round(u*_+h);p=Math.min(100,Math.max(0,p));let f=new Map;t.forEach(e=>{let t=f.get(e.theme_key)||{count:0,totalSeverity:0};t.count++,t.totalSeverity+=e.severity,f.set(e.theme_key,t)});let g=Array.from(f.entries()).map(([e,t])=>({theme_key:e,count:t.count,avg_severity:t.totalSeverity/t.count})).sort((e,t)=>t.count-e.count).slice(0,5),{data:y}=await e.from("account_snapshots").select("ofi_score").eq("account_id",o).order("snapshot_date",{ascending:!1}).limit(1).maybeSingle(),w=null,k="stable";y&&null!==y.ofi_score&&((w=p-y.ofi_score)>5?k="worsening":w<-5&&(k="improving")),await e.from("account_snapshots").insert({account_id:o,snapshot_date:new Date().toISOString().split("T")[0],ofi_score:p,friction_card_count:t.length,high_severity_count:s,case_volume:l,top_themes:g,score_breakdown:{base_score:Math.round(10*u)/10,friction_density:Math.round(10*d)/10,density_multiplier:Math.round(100*_)/100,high_severity_boost:h,severity_weighted:c,card_count:t.length},trend_vs_prior_period:w,trend_direction:k}),console.log(`✓ Snapshot created for ${a.name} with OFI ${p} (recalculated from ${t.length} existing cards)`),r.push({accountId:o,account:a.name,status:"no_new_cases",cases:0,ofi:p}),n++;continue}let v=k.map(e=>({user_id:t.user_id,account_id:o,source_type:"salesforce_case",source_id:e.Id,source_url:`${d.instance_url}/${e.Id}`,text_content:`Case #${e.CaseNumber}: ${e.Subject}

${e.Description||"No description"}`,metadata:{case_number:e.CaseNumber,subject:e.Subject,status:e.Status,origin:e.Origin||"Unknown",created_date:e.CreatedDate},processed:!1})),{data:$}=await e.from("raw_inputs").insert(v).select();if(!$||0===$.length)continue;let S=[];console.log(`Analyzing ${$.length} cases for ${a.name}...`);for(let e=0;e<$.length;e++){let r=$[e];e%20==0&&e>0&&console.log(`Progress: ${e}/${$.length} cases analyzed for ${a.name}`);let n=r.text_content?.slice(0,2e3)||"",s=r.text_content&&r.text_content.length>2e3?"\n[Case text truncated for analysis]":"",i=`Analyze this customer support case and return ONLY valid JSON with no other text, explanation, or markdown formatting.

Required JSON structure:
{
  "summary": "brief summary of the issue",
  "theme_key": "one of: billing_confusion, integration_failures, ui_confusion, performance_issues, other",
  "severity": 1-5 (number),
  "sentiment": "one of: frustrated, confused, neutral",
  "root_cause": "brief root cause hypothesis"
}

Case to analyze:
${n}${s}

Return ONLY the JSON object, nothing else.`;try{let e=await h("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":process.env.ANTHROPIC_API_KEY,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:300,messages:[{role:"user",content:i}]})});if(e.ok){let n=(await e.json()).content[0].text.replace(/```json\n?/g,"").replace(/```/g,"").trim(),s=JSON.parse(n);S.push({user_id:t.user_id,account_id:o,raw_input_id:r.id,summary:s.summary,theme_key:s.theme_key||"other",severity:s.severity||3,sentiment:s.sentiment||"neutral",root_cause_hypothesis:s.root_cause||"Unknown",evidence_snippets:[],confidence_score:.7,reasoning:"Cron analysis"})}await _(200)}catch(e){console.error("Analysis error:",e)}}if(S.length>0){await e.from("friction_cards").insert(S);let t=$.map(e=>e.id);console.log(`Marking ${t.length} inputs as processed:`,t);let{error:o}=await e.from("raw_inputs").update({processed:!0}).in("id",t);o?console.error("Error updating processed flag:",o):console.log(`Successfully marked ${t.length} inputs as processed`)}let{data:b}=await e.from("friction_cards").select("*").eq("account_id",o);if(!b||0===b.length){console.log(`No friction cards found for ${a.name} after analysis`);continue}console.log(`Calculating OFI from ${b.length} total friction cards (${S.length} new + ${b.length-S.length} existing)`);let E=b.filter(e=>e.severity>=4).length,C={1:1,2:2,3:4,4:8,5:16},O=b.reduce((e,t)=>e+(C[t.severity]||1),0),x=m.records.length||1,I=b.length/x*100,T=20*Math.log10(O+1),M=Math.min(2,Math.max(.5,I/5)),A=Math.min(20,2*E),N=Math.round(T*M+A);N=Math.min(100,Math.max(0,N)),console.log(`OFI Calculation for ${a.name}:`,{totalFrictionCards:b.length,newCards:S.length,highSeverityCount:E,totalCases:x,weightedScore:O,baseScore:T.toFixed(1),frictionDensity:I.toFixed(2)+"%",densityMultiplier:M.toFixed(2),highSeverityBoost:A,finalOfiScore:N});let F=new Map;b.forEach(e=>{let t=F.get(e.theme_key)||{count:0,totalSeverity:0};t.count++,t.totalSeverity+=e.severity,F.set(e.theme_key,t)});let D=Array.from(F.entries()).map(([e,t])=>({theme_key:e,count:t.count,avg_severity:t.totalSeverity/t.count})).sort((e,t)=>t.count-e.count).slice(0,5),{data:R}=await e.from("account_snapshots").select("ofi_score, snapshot_date").eq("account_id",o).order("snapshot_date",{ascending:!1}).limit(1).maybeSingle(),z=null,P="stable";R&&null!==R.ofi_score&&(P=(z=N-R.ofi_score)>5?"worsening":z<-5?"improving":"stable"),console.log(`Creating snapshot for ${a.name}: OFI ${N}, ${b.length} total cards (${S.length} new), trend: ${P}`);let{error:q}=await e.from("account_snapshots").insert({account_id:o,snapshot_date:new Date().toISOString().split("T")[0],ofi_score:N,friction_card_count:b.length,high_severity_count:b.filter(e=>e.severity>=4).length,case_volume:m.records.length,top_themes:D,score_breakdown:{base_score:Math.round(10*T)/10,friction_density:Math.round(10*I)/10,density_multiplier:Math.round(100*M)/100,high_severity_boost:A,severity_weighted:O,card_count:b.length},trend_vs_prior_period:z,trend_direction:P}).select();if(q)console.error(`Error creating snapshot for ${a.name}:`,q),r.push({accountId:o,account:a.name,status:"snapshot_error",error:q.message}),n++;else{console.log(`✓ Snapshot created successfully for ${a.name}`);let s=[];if(N>=70&&s.push({user_id:t.user_id,account_id:o,alert_type:"high_friction",severity:"high",title:`High Friction: ${a.name}`,message:`OFI score is ${N}, indicating significant customer friction. ${E} high-severity issues detected.`,evidence:{ofi_score:N,high_severity_count:E,friction_card_count:b.length,case_volume:m.records.length},expires_at:new Date(Date.now()+6048e5).toISOString()}),E>=3&&s.push({user_id:t.user_id,account_id:o,alert_type:"critical_severity",severity:"critical",title:`Critical Issues: ${a.name}`,message:`${E} critical severity issues detected in recent cases.`,evidence:{high_severity_count:E,ofi_score:N},expires_at:new Date(Date.now()+6048e5).toISOString()}),"worsening"===P&&z&&z>10&&s.push({user_id:t.user_id,account_id:o,alert_type:"trending_worse",severity:"medium",title:`Friction Increasing: ${a.name}`,message:`OFI score increased by ${Math.round(z)} points, from ${R?.ofi_score} to ${N}.`,evidence:{ofi_score:N,previous_ofi_score:R?.ofi_score,change:z,trend_direction:P},expires_at:new Date(Date.now()+6048e5).toISOString()}),s.length>0){let{error:t}=await e.from("alerts").insert(s);t?console.error(`Error creating alerts for ${a.name}:`,t):console.log(`✓ Created ${s.length} alert(s) for ${a.name}`)}r.push({accountId:o,account:a.name,status:"success",cases:m.records.length,analyzed:S.length,ofi:N}),n++}}catch(e){r.push({accountId:o,status:"error",error:String(e)}),n++}console.log("=== Analysis Complete ==="),console.log("Total accounts processed:",r.length);let s=r.filter(e=>"success"===e.status).length,a=r.filter(e=>"no_cases"===e.status).length,d=r.filter(e=>"failed"===e.status).length,u=r.filter(e=>"skipped"===e.status).length;return console.log(`Success: ${s}, Skipped: ${u}, No Cases: ${a}, Failed: ${d}`),console.log("Results summary:",r.map(e=>({account:e.account,status:e.status,analyzed:e.analyzed,ofi:e.ofi}))),i.Z.json({success:!0,results:r,total:r.length,summary:{analyzed:s,skipped:u,no_cases:a,failed:d}})}catch(e){return console.error("=== Analysis Failed ===",e),i.Z.json({error:"Cron failed",details:String(e)},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/cron/analyze-portfolio/route",pathname:"/api/cron/analyze-portfolio",filename:"route",bundlePath:"app/api/cron/analyze-portfolio/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/cron/analyze-portfolio/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:y,headerHooks:w,staticGenerationBailout:k}=f,v="/api/cron/analyze-portfolio/route";function $(){return(0,a.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:m})}},5218:(e,t,o)=>{function r(){let e=process.env.ENCRYPTION_KEY;if(!e)throw Error("ENCRYPTION_KEY environment variable is not set. Generate one with: openssl rand -base64 32");if(e.length<32)throw Error("ENCRYPTION_KEY must be at least 32 characters for security. Current length: "+e.length);return e}async function n(e,t){let o=r();try{let{data:r,error:n}=await e.rpc("insert_encrypted_token",{p_integration_id:t.integration_id,p_access_token:t.access_token,p_refresh_token:t.refresh_token,p_token_type:t.token_type,p_expires_at:t.expires_at,p_encryption_key:o});if(n)throw console.error("Failed to upsert encrypted token:",n),Error(`Token encryption failed: ${n.message}`);if(!r)throw Error("Token insertion returned no ID");return console.log("Token stored successfully (encrypted)"),r}catch(e){throw console.error("Encryption error:",e),e}}async function s(e,t,o,n){let s=r();try{let{data:r,error:a}=await e.rpc("update_encrypted_token",{p_token_id:t,p_access_token:o,p_expires_at:n,p_encryption_key:s});if(a)throw console.error("Failed to update encrypted token:",a),Error(`Token update failed: ${a.message}`);if(!r)return console.warn("Token update returned false - token may not exist"),!1;return console.log("Token refreshed successfully (encrypted)"),r}catch(e){throw console.error("Token update error:",e),e}}async function a(e,t){let o=r();try{let{data:r,error:n}=await e.rpc("get_decrypted_token",{p_integration_id:t,p_encryption_key:o});if(n){if(console.error("Failed to fetch/decrypt token:",n),n.message.includes("decrypt")||n.message.includes("Wrong key"))throw Error("Token decryption failed - ENCRYPTION_KEY may be incorrect or changed. Verify the key matches what was used during encryption.");throw Error(`Token retrieval failed: ${n.message}`)}if(!r||Array.isArray(r)&&0===r.length)return console.warn(`No token found for integration: ${t}`),null;let s=Array.isArray(r)?r[0]:r;if(!s.access_token)throw Error("Decrypted token is missing access_token - data may be corrupted");return s}catch(e){throw console.error("Token decryption error:",e),e}}o.d(t,{au:()=>s,fV:()=>a,nu:()=>n})}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[456,552],()=>o(45583));module.exports=r})();