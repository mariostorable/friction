"use strict";(()=>{var e={};e.id=243,e.ids=[243],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},45583:(e,t,o)=>{o.r(t),o.d(t,{headerHooks:()=>y,originalPathname:()=>S,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>h,serverHooks:()=>_,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>$});var s={};o.r(s),o.d(s,{GET:()=>f,dynamic:()=>l,maxDuration:()=>u});var a=o(95419),n=o(69108),r=o(99678),i=o(78070),c=o(23950);let l="force-dynamic",u=300,d=e=>new Promise(t=>setTimeout(t,e));async function p(e,t,o=3){for(let s=0;s<o;s++)try{let a=await fetch(e,t);if(529===a.status){let e=Math.min(1e3*Math.pow(2,s),3e4);console.log(`API overloaded (529), retrying in ${e}ms... (attempt ${s+1}/${o})`),await d(e);continue}return a}catch(e){if(s===o-1)throw e;await d(1e3*Math.pow(2,s))}throw Error("Max retries exceeded")}async function f(e){console.log("=== Analyze Portfolio Endpoint Called ==="),console.log("Auth header present:",!!e.headers.get("authorization")),console.log("CRON_SECRET configured:",!!process.env.CRON_SECRET),console.log("Auth check disabled for testing, starting analysis...");try{let e=(0,c.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),{data:t}=await e.from("portfolios").select("user_id, account_ids, portfolio_type").in("portfolio_type",["top_25_edge","top_25_sitelink"]);if(!t||0===t.length)return i.Z.json({message:"No portfolios found"});let o=[],s=0;for(let a of t)for(let t of a.account_ids)try{let{data:n}=await e.from("accounts").select("salesforce_id, name, status").eq("id",t).single();if(!n)continue;if("cancelled"===n.status||"churned"===n.status){console.log(`Skipping ${n.name} - account is ${n.status}`),o.push({accountId:t,account:n.name,status:"skipped",reason:`Account is ${n.status}`});continue}let r=new Date().toISOString().split("T")[0],{data:i}=await e.from("account_snapshots").select("id, ofi_score").eq("account_id",t).eq("snapshot_date",r).maybeSingle();if(i){console.log(`Skipping ${n.name} - already analyzed today (OFI: ${i.ofi_score})`),o.push({accountId:t,account:n.name,status:"skipped",ofi:i.ofi_score,reason:"Already analyzed today"});continue}if(s>=3){console.log("Reached max analysis limit (3), stopping to avoid timeout");break}let{data:c}=await e.from("integrations").select("*").eq("user_id",a.user_id).eq("integration_type","salesforce").single();if(!c)continue;let{data:l}=await e.from("oauth_tokens").select("*").eq("integration_id",c.id).single();if(!l)continue;let u=`SELECT Id,CaseNumber,Subject,Description,Status,Priority,CreatedDate FROM Case WHERE AccountId='${n.salesforce_id}' AND CreatedDate=LAST_N_DAYS:90 ORDER BY CreatedDate DESC LIMIT 2000`;console.log(`Fetching cases for account: ${n.name} (${n.salesforce_id})`);let f=await fetch(`${c.instance_url}/services/data/v59.0/query?q=${encodeURIComponent(u)}`,{headers:{Authorization:`Bearer ${l.access_token}`,"Content-Type":"application/json"}});if(!f.ok){console.error(`Failed to fetch cases for ${n.name}:`,f.status),o.push({accountId:t,account:n.name,status:"failed",error:"Salesforce fetch failed"});continue}let h=await f.json();if(console.log(`Found ${h.records?.length||0} cases for ${n.name}`),!h.records||0===h.records.length){let{error:a}=await e.from("account_snapshots").insert({account_id:t,snapshot_date:new Date().toISOString().split("T")[0],ofi_score:0,friction_card_count:0,high_severity_count:0,case_volume:0});a?(console.error(`Error creating snapshot for ${n.name}:`,a),o.push({accountId:t,account:n.name,status:"snapshot_error",error:a.message})):(console.log(`✓ Snapshot created for ${n.name} with OFI 0 (no cases)`),o.push({accountId:t,account:n.name,status:"no_cases",cases:0,ofi:0})),s++;continue}console.log(`Cleaning up old data for ${n.name}...`);let{error:m}=await e.from("friction_cards").delete().eq("account_id",t).eq("user_id",a.user_id);m&&console.error(`Error deleting old friction_cards for ${n.name}:`,m);let{error:g}=await e.from("raw_inputs").delete().eq("account_id",t).eq("user_id",a.user_id);g&&console.error(`Error deleting old raw_inputs for ${n.name}:`,g),console.log(`Old data cleaned up successfully for ${n.name}`);let _=h.records.map(e=>({user_id:a.user_id,account_id:t,source_type:"salesforce_case",source_id:e.Id,source_url:`${c.instance_url}/${e.Id}`,text_content:`Case #${e.CaseNumber}: ${e.Subject}

${e.Description||"No description"}`,metadata:{case_number:e.CaseNumber,subject:e.Subject,status:e.Status,created_date:e.CreatedDate},processed:!1})),{data:y}=await e.from("raw_inputs").insert(_).select();if(!y||0===y.length)continue;let $=[];console.log(`Analyzing ${y.length} cases for ${n.name}...`);for(let e=0;e<y.length;e++){let o=y[e];e%20==0&&e>0&&console.log(`Progress: ${e}/${y.length} cases analyzed for ${n.name}`);let s=o.text_content?.slice(0,2e3)||"",r=o.text_content&&o.text_content.length>2e3?"\n[Case text truncated for analysis]":"",i=`Analyze this customer support case and return ONLY valid JSON with no other text, explanation, or markdown formatting.

Required JSON structure:
{
  "summary": "brief summary of the issue",
  "theme_key": "one of: billing_confusion, integration_failures, ui_confusion, performance_issues, other",
  "severity": 1-5 (number),
  "sentiment": "one of: frustrated, confused, neutral",
  "root_cause": "brief root cause hypothesis"
}

Case to analyze:
${s}${r}

Return ONLY the JSON object, nothing else.`;try{let e=await p("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":process.env.ANTHROPIC_API_KEY,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:300,messages:[{role:"user",content:i}]})});if(e.ok){let s=(await e.json()).content[0].text.replace(/```json\n?/g,"").replace(/```/g,"").trim(),n=JSON.parse(s);$.push({user_id:a.user_id,account_id:t,raw_input_id:o.id,summary:n.summary,theme_key:n.theme_key||"other",severity:n.severity||3,sentiment:n.sentiment||"neutral",root_cause_hypothesis:n.root_cause||"Unknown",evidence_snippets:[],confidence_score:.7,reasoning:"Cron analysis"})}await d(200)}catch(e){console.error("Analysis error:",e)}}if($.length>0){await e.from("friction_cards").insert($);let a=y.map(e=>e.id);console.log(`Marking ${a.length} inputs as processed:`,a);let{error:r}=await e.from("raw_inputs").update({processed:!0}).in("id",a);r?console.error("Error updating processed flag:",r):console.log(`Successfully marked ${a.length} inputs as processed`);let i=$.filter(e=>e.severity>=4).length,c={1:1,2:2,3:4,4:8,5:16},l=$.reduce((e,t)=>e+(c[t.severity]||1),0),u=h.records.length||1,d=$.length/u*100,p=20*Math.log10(l+1),f=Math.min(2,Math.max(.5,d/5)),m=Math.min(20,2*i),g=Math.round(p*f+m);g=Math.min(100,Math.max(0,g)),console.log(`OFI Calculation for ${n.name}:`,{frictionCards:$.length,highSeverityCount:i,totalCases:u,weightedScore:l,baseScore:p.toFixed(1),frictionDensity:d.toFixed(2)+"%",densityMultiplier:f.toFixed(2),highSeverityBoost:m,finalOfiScore:g}),console.log(`Creating snapshot for ${n.name}: OFI ${g}, ${$.length} cards`);let{error:_}=await e.from("account_snapshots").insert({account_id:t,snapshot_date:new Date().toISOString().split("T")[0],ofi_score:g,friction_card_count:$.length,high_severity_count:$.filter(e=>e.severity>=4).length,case_volume:h.records.length}).select();_?(console.error(`Error creating snapshot for ${n.name}:`,_),o.push({accountId:t,account:n.name,status:"snapshot_error",error:_.message})):(console.log(`✓ Snapshot created successfully for ${n.name}`),o.push({accountId:t,account:n.name,status:"success",cases:h.records.length,analyzed:$.length,ofi:g})),s++}}catch(e){o.push({accountId:t,status:"error",error:String(e)}),s++}console.log("=== Analysis Complete ==="),console.log("Total accounts processed:",o.length);let a=o.filter(e=>"success"===e.status).length,n=o.filter(e=>"no_cases"===e.status).length,r=o.filter(e=>"failed"===e.status).length,l=o.filter(e=>"skipped"===e.status).length;return console.log(`Success: ${a}, Skipped: ${l}, No Cases: ${n}, Failed: ${r}`),console.log("Results summary:",o.map(e=>({account:e.account,status:e.status,analyzed:e.analyzed,ofi:e.ofi}))),i.Z.json({success:!0,results:o,total:o.length,summary:{analyzed:a,skipped:l,no_cases:n,failed:r}})}catch(e){return console.error("=== Analysis Failed ===",e),i.Z.json({error:"Cron failed",details:String(e)},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/cron/analyze-portfolio/route",pathname:"/api/cron/analyze-portfolio",filename:"route",bundlePath:"app/api/cron/analyze-portfolio/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/cron/analyze-portfolio/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:_,headerHooks:y,staticGenerationBailout:$}=h,S="/api/cron/analyze-portfolio/route";function w(){return(0,r.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:g})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),s=t.X(0,[456,552],()=>o(45583));module.exports=s})();