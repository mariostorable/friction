"use strict";(()=>{var e={};e.id=368,e.ids=[368],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},93087:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>y,originalPathname:()=>w,patchFetch:()=>A,requestAsyncStorage:()=>m,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>_});var s={};r.r(s),r.d(s,{POST:()=>p,maxDuration:()=>d});var o=r(95419),n=r(69108),i=r(99678),a=r(78070),c=r(57699),l=r(23950),u=r(7439);let d=300;async function p(e){try{let t=(0,c.createRouteHandlerClient)({cookies:u.cookies}),{data:{user:r}}=await t.auth.getUser();if(!r)return a.Z.json({error:"Not authenticated"},{status:401});let{accountId:s}=await e.json();if(!s)return a.Z.json({error:"Account ID required"},{status:400});if(console.log("Analyzing friction for account:",s),!process.env.ANTHROPIC_API_KEY)return a.Z.json({error:"Claude API key not configured. Please set ANTHROPIC_API_KEY environment variable.",analyzed:0},{status:500});let{data:o}=await t.from("raw_inputs").select("*").eq("account_id",s).eq("user_id",r.id).eq("processed",!1).order("created_at",{ascending:!1}).limit(50);if(console.log("Found raw inputs:",o?.length||0),!o||0===o.length)return a.Z.json({error:"No unprocessed cases found. Make sure you synced cases first.",analyzed:0},{status:404});let n=[],i=0,d=0,p=0,f=[],m=e=>new Promise(t=>setTimeout(t,e)),g=async(e,t=5)=>{for(let r=0;r<t;r++)try{let s=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":process.env.ANTHROPIC_API_KEY,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1e3,messages:[{role:"user",content:e}]})});if(529===s.status||429===s.status){let e=Math.min(3e3*Math.pow(2,r),6e4);console.log(`API busy (${s.status}), waiting ${e/1e3}s before retry ${r+1}/${t}...`),await m(e);continue}return s}catch(s){let e=Math.min(3e3*Math.pow(2,r),6e4);if(console.error(`Request error on attempt ${r+1}:`,s),r===t-1)throw Error(`API overloaded after ${t} retries. The service is experiencing high demand. Please wait 2-3 minutes and try again.`);await m(e)}throw Error(`API overloaded after ${t} retries. Please try again in a few minutes.`)};for(let e=0;e<o.length;e++){let t=o[e];e%10==0&&console.log(`Processing case ${e+1}/${o.length}...`);let c=t.text_content?.slice(0,2e3)||"",l=t.text_content&&t.text_content.length>2e3?"\n[Case text truncated for analysis]":"",u=`Analyze this support case and respond with ONLY valid JSON (no markdown):

${c}${l}

Return a single JSON object with these fields:

FIRST, determine if this is actual friction or routine support:
- is_friction: true/false
  * TRUE = User is blocked, confused, frustrated, experiencing errors, or encountering product limitations
  * FALSE = Routine questions, transactional requests (change email/password), positive feedback, simple how-to questions that are easily answered, or feature requests without clear pain

If is_friction is FALSE, stop here and return: {"is_friction": false, "reason": "brief explanation"}

If is_friction is TRUE, continue with:
- summary: Brief description of the issue (1 sentence)
- theme_key: Choose the MOST SPECIFIC theme. "other" should be under 10% of cases:
  * billing_confusion: Invoice, payment, pricing, subscription issues
  * integration_failures: API issues, third-party app connections, data sync problems
  * ui_confusion: Interface unclear, hard to find features, confusing workflow
  * performance_issues: Slow load times, timeouts, system lag
  * missing_features: Requested functionality doesn't exist
  * training_gaps: User doesn't know how to use existing features
  * support_response_time: Complaints about support speed or quality
  * data_quality: Incorrect data, missing data, data inconsistencies
  * reporting_issues: Problems with reports, exports, analytics
  * access_permissions: User access, role permissions, login issues
  * configuration_problems: Settings not working, setup issues
  * notification_issues: Email alerts, in-app notifications problems
  * workflow_inefficiency: Process is too complex or time-consuming
  * mobile_issues: Mobile app or mobile web problems
  * documentation_gaps: Help docs missing, outdated, or unclear
  * other: ONLY if absolutely none of the above apply (should be rare)
- severity: 1-5 (1=minor inconvenience, 5=critical blocker)
- sentiment: frustrated, confused, angry, neutral, satisfied
- root_cause: Your hypothesis about the underlying cause
- evidence: Array of max 2 short quotes from the case that support your analysis`,h=await g(u);if(!h.ok){d++;let e=await h.json().catch(()=>({})),t=`API Error ${h.status}: ${e.error?.message||JSON.stringify(e)}`;if(console.error("Anthropic API error:",t),f.push(t),1===d)return a.Z.json({error:`Claude API call failed: ${t}`,analyzed:0,api_errors:d},{status:500});continue}let y=(await h.json()).content[0].text.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();try{let e=JSON.parse(y);if(!1===e.is_friction){p++,console.log(`Skipping non-friction case ${t.id}: ${e.reason||"Not friction"}`),await m(300);continue}n.push({user_id:r.id,account_id:s,raw_input_id:t.id,summary:e.summary,theme_key:e.theme_key||"other",product_area:null,severity:Math.min(5,Math.max(1,e.severity)),sentiment:e.sentiment||"neutral",root_cause_hypothesis:e.root_cause||"Unknown",evidence_snippets:e.evidence||[],confidence_score:.8,reasoning:"Analyzed by Claude Sonnet 4.5",lifecycle_stage:null,is_new_theme:!1}),await m(300)}catch(e){i++,console.error("Parse error for case:",t.id,e)}}console.log(`Analyzed ${n.length} friction cases, ${p} non-friction filtered, ${i} parse errors, ${d} API errors`);let h=o.map(e=>e.id);console.log(`Marking ${h.length} inputs as processed (including ${i+d} failed):`,h);let y=(0,l.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),{error:_}=await y.from("raw_inputs").update({processed:!0}).in("id",h);if(_?console.error("CRITICAL: Failed to mark inputs as processed:",_):console.log(`Successfully marked ${h.length} inputs as processed`),0===n.length){if(p===o.length)return a.Z.json({success:!0,analyzed:0,filtered:p,remaining:0,message:`All ${p} cases were routine support (not friction). Cases marked as processed.`});return a.Z.json({error:`No friction cases found. Tried ${o.length} cases. Non-friction filtered: ${p}, API errors: ${d}, Parse errors: ${i}. ${f[0]||"Unknown error"}`,analyzed:0,filtered:p,parse_errors:i,api_errors:d,sample_error:f[0],marked_processed:h.length},{status:500})}let{data:w,error:A}=await t.from("friction_cards").insert(n).select();if(A)return console.error("Card insert error:",JSON.stringify(A)),a.Z.json({error:"Failed to create friction cards",details:A.message,code:A.code},{status:500});let{count:P}=await t.from("raw_inputs").select("*",{count:"exact",head:!0}).eq("account_id",s).eq("user_id",r.id).eq("processed",!1),$=P&&P>0?`Processed ${o.length} cases: ${w?.length} friction cards created, ${p} routine support filtered. ${P} more cases remaining - click Analyze again to continue.`:`Processed ${o.length} cases: ${w?.length} friction cards created, ${p} routine support filtered. All cases processed!`;return a.Z.json({success:!0,analyzed:w?.length||0,processed:o.length,filtered:p,remaining:P||0,message:$})}catch(e){return console.error("Analysis error:",e),a.Z.json({error:"Analysis failed",details:e instanceof Error?e.message:"Unknown"},{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/analyze-friction/route",pathname:"/api/analyze-friction",filename:"route",bundlePath:"app/api/analyze-friction/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/analyze-friction/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:h,headerHooks:y,staticGenerationBailout:_}=f,w="/api/analyze-friction/route";function A(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[456,552,421],()=>r(93087));module.exports=s})();