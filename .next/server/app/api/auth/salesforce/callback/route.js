"use strict";(()=>{var e={};e.id=719,e.ids=[719],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},1374:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>k,originalPathname:()=>m,patchFetch:()=>w,requestAsyncStorage:()=>_,routeModule:()=>f,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>y});var o={};t.r(o),t.d(o,{GET:()=>p});var n=t(95419),a=t(69108),s=t(99678),i=t(78070),c=t(57699),l=t(23950),d=t(7439),u=t(5218);async function p(e){let r=new URL(e.url),t=r.searchParams.get("code");if(r.searchParams.get("error"))return i.Z.redirect(`${r.origin}/dashboard?error=salesforce_auth_failed`);if(!t)return i.Z.redirect(`${r.origin}/dashboard?error=no_code`);try{console.log("=== Salesforce OAuth Callback Started ===");let e=(0,c.createRouteHandlerClient)({cookies:d.cookies}),{data:{user:o},error:n}=await e.auth.getUser();if(console.log("User authentication:",o?"SUCCESS":"FAILED",n),!o)throw Error("Not authenticated");let a=(0,l.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:s}=await a.from("profiles").select("id").eq("id",o.id).single();if(!s){console.log("Profile missing, creating one...");let{error:e}=await a.from("profiles").insert({id:o.id,email:o.email,full_name:o.user_metadata?.full_name||o.user_metadata?.name||null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(e)throw console.error("Profile creation error:",e),Error(`Failed to create profile: ${e.message}`);console.log("Profile created successfully")}let p={grant_type:"authorization_code",code:t,client_id:process.env.SALESFORCE_CLIENT_ID,client_secret:process.env.SALESFORCE_CLIENT_SECRET,redirect_uri:process.env.SALESFORCE_REDIRECT_URI};console.log("Exchanging code for tokens...");let f=await fetch("https://storable.my.salesforce.com/services/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(p)});if(console.log("Token response status:",f.status),!f.ok){let e=await f.text();throw console.error("Salesforce token exchange failed:",e),Error(`Salesforce API error: ${e}`)}let _=await f.json();console.log("Token exchange successful! Instance URL:",_.instance_url);let{data:h,error:g}=await e.from("integrations").upsert({user_id:o.id,integration_type:"salesforce",status:"active",instance_url:_.instance_url||null,metadata:{},connected_at:new Date().toISOString()}).select().single();if(g)throw console.error("Integration storage error:",g),g;console.log("Integration stored:",h.id);try{let e=await (0,u.nu)(a,{integration_id:h.id,access_token:_.access_token,refresh_token:_.refresh_token||null,token_type:"Bearer",expires_at:_.issued_at?new Date(parseInt(_.issued_at)+72e5).toISOString():new Date(Date.now()+72e5).toISOString()});console.log("Tokens stored successfully (encrypted)!",e)}catch(e){throw console.error("Failed to store encrypted tokens:",e),Error(`Token storage failed: ${e instanceof Error?e.message:"Unknown error"}`)}return console.log("=== Salesforce OAuth Callback Complete ==="),i.Z.redirect(`${r.origin}/dashboard?salesforce=connected`)}catch(e){return console.error("Salesforce OAuth error:",e),i.Z.redirect(`${r.origin}/dashboard?error=salesforce_connection_failed&details=${encodeURIComponent(e instanceof Error?e.message:"Unknown error")}`)}}let f=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/auth/salesforce/callback/route",pathname:"/api/auth/salesforce/callback",filename:"route",bundlePath:"app/api/auth/salesforce/callback/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/auth/salesforce/callback/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:_,staticGenerationAsyncStorage:h,serverHooks:g,headerHooks:k,staticGenerationBailout:y}=f,m="/api/auth/salesforce/callback/route";function w(){return(0,s.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}},5218:(e,r,t)=>{function o(){let e=process.env.ENCRYPTION_KEY;if(!e)throw Error("ENCRYPTION_KEY environment variable is not set. Generate one with: openssl rand -base64 32");if(e.length<32)throw Error("ENCRYPTION_KEY must be at least 32 characters for security. Current length: "+e.length);return e}async function n(e,r){let t=o();try{let{data:o,error:n}=await e.rpc("insert_encrypted_token",{p_integration_id:r.integration_id,p_access_token:r.access_token,p_refresh_token:r.refresh_token,p_token_type:r.token_type,p_expires_at:r.expires_at,p_encryption_key:t});if(n)throw console.error("Failed to upsert encrypted token:",n),Error(`Token encryption failed: ${n.message}`);if(!o)throw Error("Token insertion returned no ID");return console.log("Token stored successfully (encrypted)"),o}catch(e){throw console.error("Encryption error:",e),e}}async function a(e,r,t,n){let a=o();try{let{data:o,error:s}=await e.rpc("update_encrypted_token",{p_token_id:r,p_access_token:t,p_expires_at:n,p_encryption_key:a});if(s)throw console.error("Failed to update encrypted token:",s),Error(`Token update failed: ${s.message}`);if(!o)return console.warn("Token update returned false - token may not exist"),!1;return console.log("Token refreshed successfully (encrypted)"),o}catch(e){throw console.error("Token update error:",e),e}}async function s(e,r){let t=o();try{let{data:o,error:n}=await e.rpc("get_decrypted_token",{p_integration_id:r,p_encryption_key:t});if(n){if(console.error("Failed to fetch/decrypt token:",n),n.message.includes("decrypt")||n.message.includes("Wrong key"))throw Error("Token decryption failed - ENCRYPTION_KEY may be incorrect or changed. Verify the key matches what was used during encryption.");throw Error(`Token retrieval failed: ${n.message}`)}if(!o||Array.isArray(o)&&0===o.length)return console.warn(`No token found for integration: ${r}`),null;let a=Array.isArray(o)?o[0]:o;if(!a.access_token)throw Error("Decrypted token is missing access_token - data may be corrupted");return a}catch(e){throw console.error("Token decryption error:",e),e}}t.d(r,{au:()=>a,fV:()=>s,nu:()=>n})}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[456,552,421],()=>t(1374));module.exports=o})();