"use strict";(()=>{var e={};e.id=719,e.ids=[719],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},1374:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>_,originalPathname:()=>S,patchFetch:()=>k,requestAsyncStorage:()=>p,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>m});var o={};t.r(o),t.d(o,{GET:()=>d});var a=t(95419),s=t(69108),n=t(99678),i=t(78070),c=t(57699),l=t(23950),u=t(7439);async function d(e){let r=new URL(e.url),t=r.searchParams.get("code");if(r.searchParams.get("error"))return i.Z.redirect(`${r.origin}/dashboard?error=salesforce_auth_failed`);if(!t)return i.Z.redirect(`${r.origin}/dashboard?error=no_code`);try{console.log("=== Salesforce OAuth Callback Started ===");let e=(0,c.createRouteHandlerClient)({cookies:u.cookies}),{data:{user:o},error:a}=await e.auth.getUser();if(console.log("User authentication:",o?"SUCCESS":"FAILED",a),!o)throw Error("Not authenticated");let s=(0,l.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:n}=await s.from("profiles").select("id").eq("id",o.id).single();if(!n){console.log("Profile missing, creating one...");let{error:e}=await s.from("profiles").insert({id:o.id,email:o.email,full_name:o.user_metadata?.full_name||o.user_metadata?.name||null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(e)throw console.error("Profile creation error:",e),Error(`Failed to create profile: ${e.message}`);console.log("Profile created successfully")}let d={grant_type:"authorization_code",code:t,client_id:process.env.SALESFORCE_CLIENT_ID,client_secret:process.env.SALESFORCE_CLIENT_SECRET,redirect_uri:process.env.SALESFORCE_REDIRECT_URI};console.log("Exchanging code for tokens...");let f=await fetch("https://storable.my.salesforce.com/services/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(d)});if(console.log("Token response status:",f.status),!f.ok){let e=await f.text();throw console.error("Salesforce token exchange failed:",e),Error(`Salesforce API error: ${e}`)}let p=await f.json();console.log("Token exchange successful! Instance URL:",p.instance_url);let{data:g,error:h}=await e.from("integrations").upsert({user_id:o.id,integration_type:"salesforce",status:"active",instance_url:p.instance_url||null,metadata:{},connected_at:new Date().toISOString()}).select().single();if(h)throw console.error("Integration storage error:",h),h;console.log("Integration stored:",g.id);let{data:_,error:m}=await s.from("oauth_tokens").upsert({integration_id:g.id,access_token:p.access_token,refresh_token:p.refresh_token||null,token_type:"Bearer",expires_at:p.issued_at?new Date(parseInt(p.issued_at)+72e5).toISOString():new Date(Date.now()+72e5).toISOString()}).select().single();if(m)throw console.error("Failed to store tokens:",m),Error(`Token storage failed: ${m.message}`);return console.log("Tokens stored successfully!",_.id),console.log("=== Salesforce OAuth Callback Complete ==="),i.Z.redirect(`${r.origin}/dashboard?salesforce=connected`)}catch(e){return console.error("Salesforce OAuth error:",e),i.Z.redirect(`${r.origin}/dashboard?error=salesforce_connection_failed&details=${encodeURIComponent(e instanceof Error?e.message:"Unknown error")}`)}}let f=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/salesforce/callback/route",pathname:"/api/auth/salesforce/callback",filename:"route",bundlePath:"app/api/auth/salesforce/callback/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/auth/salesforce/callback/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:h,headerHooks:_,staticGenerationBailout:m}=f,S="/api/auth/salesforce/callback/route";function k(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[456,552,421],()=>t(1374));module.exports=o})();