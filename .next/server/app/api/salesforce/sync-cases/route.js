"use strict";(()=>{var e={};e.id=952,e.ids=[952],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},11402:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>m,originalPathname:()=>w,patchFetch:()=>S,requestAsyncStorage:()=>_,routeModule:()=>y,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>k});var s={};t.r(s),t.d(s,{POST:()=>p,maxDuration:()=>f});var o=t(95419),n=t(69108),a=t(99678),c=t(78070),i=t(57699),l=t(23950),d=t(7439),u=t(5218);let f=60;async function p(e){try{let r,t;let s=(0,i.createRouteHandlerClient)({cookies:d.cookies}),{data:{user:o}}=await s.auth.getUser();if(!o)return c.Z.json({error:"Not authenticated"},{status:401});let{accountId:n}=await e.json();if(!n)return c.Z.json({error:"Account ID required"},{status:400});let{data:a}=await s.from("accounts").select("salesforce_id, name").eq("id",n).eq("user_id",o.id).single();if(!a)return c.Z.json({error:"Account not found"},{status:404});console.log(`Syncing cases for account: ${a.name} (SF ID: ${a.salesforce_id})`);let{data:f}=await s.from("raw_inputs").select("metadata").eq("account_id",n).eq("user_id",o.id).order("created_at",{ascending:!1}).limit(1).single(),p=f?.metadata?.created_date,y=!p;console.log("Last sync date:",p||"Never (first sync)");let{data:_}=await s.from("integrations").select("*").eq("user_id",o.id).eq("integration_type","salesforce").eq("status","active").single();if(!_)return c.Z.json({error:"Salesforce not connected"},{status:400});let g=(0,l.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});try{r=await (0,u.fV)(g,_.id)}catch(e){return console.error("Failed to decrypt tokens:",e),c.Z.json({error:"Failed to access credentials",details:"Please reconnect Salesforce"},{status:500})}if(!r)return c.Z.json({error:"No tokens found"},{status:400});let h=async()=>{if(!r.refresh_token)throw Error("No refresh token available. Please reconnect Salesforce.");console.log("Refreshing Salesforce token...");let e=await fetch("https://storable.my.salesforce.com/services/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:r.refresh_token,client_id:process.env.SALESFORCE_CLIENT_ID,client_secret:process.env.SALESFORCE_CLIENT_SECRET})});if(!e.ok){let r=await e.text();throw console.error("Token refresh failed:",r),Error("Failed to refresh Salesforce token. Please reconnect Salesforce.")}let t=await e.json();return console.log("Token refreshed successfully"),await (0,u.au)(g,r.id,t.access_token,new Date(Date.now()+72e5).toISOString()),t.access_token};y?(t="CreatedDate=LAST_N_DAYS:90",console.log("First sync - fetching last 90 days")):(t=`CreatedDate>${p}`,console.log("Incremental sync - fetching cases since",p));let m=`SELECT Id,CaseNumber,Subject,Description,Status,Priority,CreatedDate,ClosedDate,Origin FROM Case WHERE AccountId='${a.salesforce_id}' AND ${t} ORDER BY CreatedDate DESC LIMIT 2000`,k=`${_.instance_url}/services/data/v59.0/query?q=${encodeURIComponent(m)}`;console.log("Salesforce Query:",m);let w=async e=>await fetch(k,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),S=await w(r.access_token);if(console.log("Salesforce Response Status:",S.status),401===S.status){console.log("Access token expired, refreshing...");try{let e=await h();S=await w(e)}catch(e){return c.Z.json({error:"Salesforce token expired",details:e instanceof Error?e.message:"Please reconnect Salesforce from Settings",needsReconnect:!0},{status:401})}}if(!S.ok){let e=await S.text();return console.error("Salesforce Error:",e),c.Z.json({error:"Failed to fetch cases from Salesforce",details:e},{status:500})}let E=await S.json();if(console.log("Cases returned:",E.totalSize||0),console.log("Case records length:",E.records?.length||0),!E.records||0===E.records.length){let e=y?`No cases found for ${a.name} in the last 90 days.`:`No new cases since last sync (${new Date(p).toLocaleDateString()}).`;return console.log(e),c.Z.json({success:!0,synced:0,accountName:a.name,message:e,isIncremental:!y},{status:200})}if(y){console.log("First sync - cleaning up any existing data...");let{error:e}=await s.from("friction_cards").delete().eq("account_id",n).eq("user_id",o.id);e&&console.error("Error deleting old friction_cards:",e);let{error:r}=await s.from("raw_inputs").delete().eq("account_id",n).eq("user_id",o.id);r&&console.error("Error deleting old raw_inputs:",r),console.log("Old data cleaned up successfully")}else console.log(`Incremental sync - adding ${E.records.length} new cases to existing data`);E.records.length>0&&console.log("Sample case data from Salesforce:",{CaseNumber:E.records[0].CaseNumber,Origin:E.records[0].Origin,allFields:Object.keys(E.records[0])});let C=E.records.map(e=>{let r=e.Origin||e.origin||e.CaseOrigin||"Unknown";return{user_id:o.id,account_id:n,source_type:"salesforce_case",source_id:e.Id,source_url:`${_.instance_url}/${e.Id}`,text_content:`Case #${e.CaseNumber}: ${e.Subject}

${e.Description||"No description"}

Status: ${e.Status}
Priority: ${e.Priority}
Origin: ${r}`,metadata:{case_number:e.CaseNumber,subject:e.Subject,status:e.Status,priority:e.Priority,origin:r,created_date:e.CreatedDate,closed_date:e.ClosedDate},processed:!1}}),{data:x,error:T}=await s.from("raw_inputs").insert(C).select();if(T)return console.error("Insert error:",T),c.Z.json({error:"Failed to store cases",details:T.message},{status:500});return console.log("Successfully inserted:",x?.length),c.Z.json({success:!0,synced:x?.length||0,accountName:a.name,message:`${y?"Full sync":"Incremental sync"}: Added ${x?.length} ${y?"":"new "}cases for ${a.name}`,isIncremental:!y})}catch(e){return console.error("Case sync error:",e),c.Z.json({error:"Case sync failed",details:e instanceof Error?e.message:"Unknown"},{status:500})}}let y=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/salesforce/sync-cases/route",pathname:"/api/salesforce/sync-cases",filename:"route",bundlePath:"app/api/salesforce/sync-cases/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/salesforce/sync-cases/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:g,serverHooks:h,headerHooks:m,staticGenerationBailout:k}=y,w="/api/salesforce/sync-cases/route";function S(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},5218:(e,r,t)=>{function s(){let e=process.env.ENCRYPTION_KEY;if(!e)throw Error("ENCRYPTION_KEY environment variable is not set. Generate one with: openssl rand -base64 32");if(e.length<32)throw Error("ENCRYPTION_KEY must be at least 32 characters for security. Current length: "+e.length);return e}async function o(e,r){let t=s();try{let{data:s,error:o}=await e.rpc("insert_encrypted_token",{p_integration_id:r.integration_id,p_access_token:r.access_token,p_refresh_token:r.refresh_token,p_token_type:r.token_type,p_expires_at:r.expires_at,p_encryption_key:t});if(o)throw console.error("Failed to upsert encrypted token:",o),Error(`Token encryption failed: ${o.message}`);if(!s)throw Error("Token insertion returned no ID");return console.log("Token stored successfully (encrypted)"),s}catch(e){throw console.error("Encryption error:",e),e}}async function n(e,r,t,o){let n=s();try{let{data:s,error:a}=await e.rpc("update_encrypted_token",{p_token_id:r,p_access_token:t,p_expires_at:o,p_encryption_key:n});if(a)throw console.error("Failed to update encrypted token:",a),Error(`Token update failed: ${a.message}`);if(!s)return console.warn("Token update returned false - token may not exist"),!1;return console.log("Token refreshed successfully (encrypted)"),s}catch(e){throw console.error("Token update error:",e),e}}async function a(e,r){let t=s();try{let{data:s,error:o}=await e.rpc("get_decrypted_token",{p_integration_id:r,p_encryption_key:t});if(o){if(console.error("Failed to fetch/decrypt token:",o),o.message.includes("decrypt")||o.message.includes("Wrong key"))throw Error("Token decryption failed - ENCRYPTION_KEY may be incorrect or changed. Verify the key matches what was used during encryption.");throw Error(`Token retrieval failed: ${o.message}`)}if(!s||Array.isArray(s)&&0===s.length)return console.warn(`No token found for integration: ${r}`),null;let n=Array.isArray(s)?s[0]:s;if(!n.access_token)throw Error("Decrypted token is missing access_token - data may be corrupted");return n}catch(e){throw console.error("Token decryption error:",e),e}}t.d(r,{au:()=>n,fV:()=>a,nu:()=>o})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[456,552,421],()=>t(11402));module.exports=s})();