"use strict";(()=>{var e={};e.id=952,e.ids=[952],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},11402:(e,t,s)=>{s.r(t),s.d(t,{headerHooks:()=>_,originalPathname:()=>S,patchFetch:()=>w,requestAsyncStorage:()=>p,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>h});var r={};s.r(r),s.d(r,{POST:()=>g,maxDuration:()=>u});var a=s(95419),o=s(69108),n=s(99678),c=s(78070),i=s(57699),l=s(23950),d=s(7439);let u=60;async function g(e){try{let t;let s=(0,i.createRouteHandlerClient)({cookies:d.cookies}),{data:{user:r}}=await s.auth.getUser();if(!r)return c.Z.json({error:"Not authenticated"},{status:401});let{accountId:a}=await e.json();if(!a)return c.Z.json({error:"Account ID required"},{status:400});let{data:o}=await s.from("accounts").select("salesforce_id, name").eq("id",a).eq("user_id",r.id).single();if(!o)return c.Z.json({error:"Account not found"},{status:404});console.log(`Syncing cases for account: ${o.name} (SF ID: ${o.salesforce_id})`);let{data:n}=await s.from("raw_inputs").select("metadata").eq("account_id",a).eq("user_id",r.id).order("created_at",{ascending:!1}).limit(1).single(),u=n?.metadata?.created_date,g=!u;console.log("Last sync date:",u||"Never (first sync)");let{data:f}=await s.from("integrations").select("*").eq("user_id",r.id).eq("integration_type","salesforce").eq("status","active").single();if(!f)return c.Z.json({error:"Salesforce not connected"},{status:400});let p=(0,l.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:m}=await p.from("oauth_tokens").select("*").eq("integration_id",f.id).single();if(!m)return c.Z.json({error:"No tokens found"},{status:400});g?(t="CreatedDate=LAST_N_DAYS:90",console.log("First sync - fetching last 90 days")):(t=`CreatedDate>${u}`,console.log("Incremental sync - fetching cases since",u));let y=`SELECT Id,CaseNumber,Subject,Description,Status,Priority,CreatedDate,ClosedDate,Origin FROM Case WHERE AccountId='${o.salesforce_id}' AND ${t} ORDER BY CreatedDate DESC LIMIT 2000`,_=`${f.instance_url}/services/data/v59.0/query?q=${encodeURIComponent(y)}`;console.log("Salesforce Query:",y);let h=await fetch(_,{headers:{Authorization:`Bearer ${m.access_token}`,"Content-Type":"application/json"}});if(console.log("Salesforce Response Status:",h.status),!h.ok){let e=await h.text();return console.error("Salesforce Error:",e),c.Z.json({error:"Failed to fetch cases from Salesforce",details:e},{status:500})}let S=await h.json();if(console.log("Cases returned:",S.totalSize||0),console.log("Case records length:",S.records?.length||0),!S.records||0===S.records.length){let e=g?`No cases found for ${o.name} in the last 90 days.`:`No new cases since last sync (${new Date(u).toLocaleDateString()}).`;return console.log(e),c.Z.json({success:!0,synced:0,accountName:o.name,message:e,isIncremental:!g},{status:200})}if(g){console.log("First sync - cleaning up any existing data...");let{error:e}=await s.from("friction_cards").delete().eq("account_id",a).eq("user_id",r.id);e&&console.error("Error deleting old friction_cards:",e);let{error:t}=await s.from("raw_inputs").delete().eq("account_id",a).eq("user_id",r.id);t&&console.error("Error deleting old raw_inputs:",t),console.log("Old data cleaned up successfully")}else console.log(`Incremental sync - adding ${S.records.length} new cases to existing data`);let w=S.records.map(e=>({user_id:r.id,account_id:a,source_type:"salesforce_case",source_id:e.Id,source_url:`${f.instance_url}/${e.Id}`,text_content:`Case #${e.CaseNumber}: ${e.Subject}

${e.Description||"No description"}

Status: ${e.Status}
Priority: ${e.Priority}
Origin: ${e.Origin}`,metadata:{case_number:e.CaseNumber,subject:e.Subject,status:e.Status,priority:e.Priority,origin:e.Origin,created_date:e.CreatedDate,closed_date:e.ClosedDate},processed:!1})),{data:C,error:q}=await s.from("raw_inputs").insert(w).select();if(q)return console.error("Insert error:",q),c.Z.json({error:"Failed to store cases",details:q.message},{status:500});return console.log("Successfully inserted:",C?.length),c.Z.json({success:!0,synced:C?.length||0,accountName:o.name,message:`${g?"Full sync":"Incremental sync"}: Added ${C?.length} ${g?"":"new "}cases for ${o.name}`,isIncremental:!g})}catch(e){return console.error("Case sync error:",e),c.Z.json({error:"Case sync failed",details:e instanceof Error?e.message:"Unknown"},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/salesforce/sync-cases/route",pathname:"/api/salesforce/sync-cases",filename:"route",bundlePath:"app/api/salesforce/sync-cases/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/salesforce/sync-cases/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:y,headerHooks:_,staticGenerationBailout:h}=f,S="/api/salesforce/sync-cases/route";function w(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:m})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[456,552,421],()=>s(11402));module.exports=r})();