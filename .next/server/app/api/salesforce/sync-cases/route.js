"use strict";(()=>{var e={};e.id=952,e.ids=[952],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},11402:(e,t,s)=>{s.r(t),s.d(t,{headerHooks:()=>y,originalPathname:()=>_,patchFetch:()=>h,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>S});var r={};s.r(r),s.d(r,{POST:()=>d});var a=s(95419),o=s(69108),n=s(99678),i=s(78070),c=s(57699),u=s(23950),l=s(7439);async function d(e){try{let t=(0,c.createRouteHandlerClient)({cookies:l.cookies}),{data:{user:s}}=await t.auth.getUser();if(!s)return i.Z.json({error:"Not authenticated"},{status:401});let{accountId:r}=await e.json();if(!r)return i.Z.json({error:"Account ID required"},{status:400});let{data:a}=await t.from("accounts").select("salesforce_id, name").eq("id",r).eq("user_id",s.id).single();if(!a)return i.Z.json({error:"Account not found"},{status:404});console.log(`Syncing cases for account: ${a.name} (SF ID: ${a.salesforce_id})`);let{data:o}=await t.from("integrations").select("*").eq("user_id",s.id).eq("integration_type","salesforce").eq("status","active").single();if(!o)return i.Z.json({error:"Salesforce not connected"},{status:400});let n=(0,u.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:d}=await n.from("oauth_tokens").select("*").eq("integration_id",o.id).single();if(!d)return i.Z.json({error:"No tokens found"},{status:400});let p=`SELECT Id,CaseNumber,Subject,Description,Status,Priority,CreatedDate,ClosedDate,Origin FROM Case WHERE AccountId='${a.salesforce_id}' AND CreatedDate=LAST_N_DAYS:90 ORDER BY CreatedDate DESC LIMIT 100`,f=`${o.instance_url}/services/data/v59.0/query?q=${encodeURIComponent(p)}`;console.log("Salesforce Query URL:",f);let g=await fetch(f,{headers:{Authorization:`Bearer ${d.access_token}`,"Content-Type":"application/json"}});if(console.log("Salesforce Response Status:",g.status),!g.ok){let e=await g.text();return console.error("Salesforce Error:",e),i.Z.json({error:"Failed to fetch cases",details:e},{status:500})}let m=await g.json();if(console.log("Cases returned:",m.totalSize||0),!m.records||0===m.records.length)return i.Z.json({message:"No cases found",synced:0,accountName:a.name});let y=m.records.map(e=>({user_id:s.id,account_id:r,source_type:"salesforce_case",source_id:e.Id,source_url:`${o.instance_url}/${e.Id}`,text_content:`Case #${e.CaseNumber}: ${e.Subject}

${e.Description||"No description"}

Status: ${e.Status}
Priority: ${e.Priority}
Origin: ${e.Origin}`,metadata:{case_number:e.CaseNumber,subject:e.Subject,status:e.Status,priority:e.Priority,origin:e.Origin,created_date:e.CreatedDate,closed_date:e.ClosedDate},processed:!1})),{data:S,error:_}=await t.from("raw_inputs").insert(y).select();if(_)return console.error("Insert error:",_),i.Z.json({error:"Failed to store cases",details:_.message},{status:500});return console.log("Successfully inserted:",S?.length),i.Z.json({success:!0,synced:S?.length||0,accountName:a.name,message:`Synced ${S?.length} cases for ${a.name}`})}catch(e){return console.error("Case sync error:",e),i.Z.json({error:"Case sync failed",details:e instanceof Error?e.message:"Unknown"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/salesforce/sync-cases/route",pathname:"/api/salesforce/sync-cases",filename:"route",bundlePath:"app/api/salesforce/sync-cases/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/salesforce/sync-cases/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:m,headerHooks:y,staticGenerationBailout:S}=p,_="/api/salesforce/sync-cases/route";function h(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[456,552,421],()=>s(11402));module.exports=r})();