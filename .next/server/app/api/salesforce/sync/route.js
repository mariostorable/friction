"use strict";(()=>{var e={};e.id=638,e.ids=[638],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},13655:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>m,originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>y});var n={};r.r(n),r.d(n,{POST:()=>u});var a=r(95419),s=r(69108),i=r(99678),o=r(78070),c=r(57699),l=r(23950),_=r(7439);async function u(e){try{let t=(0,c.createRouteHandlerClient)({cookies:_.cookies}),{data:{user:r}}=await t.auth.getUser();if(!r)return o.Z.json({error:"Not authenticated"},{status:401});let{data:n}=await t.from("integrations").select("*").eq("user_id",r.id).eq("integration_type","salesforce").eq("status","active").single();if(!n)return o.Z.json({error:"Salesforce not connected"},{status:400});let a=(0,l.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:s}=await a.from("oauth_tokens").select("*").eq("integration_id",n.id).single();if(!s)return o.Z.json({error:"No tokens found"},{status:400});let i=await fetch(`${n.instance_url}/services/data/v59.0/query?q=SELECT+Id,Name,MRR_MVR__c,Industry,Type,Owner.Name,CreatedDate,Current_FMS__c,Online_Listing_Service__c,Current_Website_Provider__c,Current_Payment_Provider__c,Insurance_Company__c,Gate_System__c,LevelOfService__c,Managed_Account__c,VitallyClient_Success_Tier__c,Locations__c,(SELECT+Id+FROM+Assets)+FROM+Account+WHERE+ParentId=null+AND+MRR_MVR__c!=null+ORDER+BY+MRR_MVR__c+DESC+LIMIT+200`,{headers:{Authorization:`Bearer ${s.access_token}`,"Content-Type":"application/json"}});if(!i.ok){let e=await i.text();return o.Z.json({error:"Failed to fetch accounts",details:e},{status:500})}let u=await i.json();if(!u.records||0===u.records.length)return o.Z.json({message:"No accounts found",synced:0});let d=u.records.map(e=>{let t=[];return e.Current_FMS__c&&t.push(`Software (${e.Current_FMS__c})`),e.Online_Listing_Service__c&&t.push(`Marketplace (${e.Online_Listing_Service__c})`),e.Current_Website_Provider__c&&t.push(`Website (${e.Current_Website_Provider__c})`),e.Current_Payment_Provider__c&&t.push(`Payments (${e.Current_Payment_Provider__c})`),e.Insurance_Company__c&&t.push(`Insurance (${e.Insurance_Company__c})`),e.Gate_System__c&&t.push(`Gate (${e.Gate_System__c})`),{user_id:r.id,salesforce_id:e.Id,name:e.Name,arr:e.MRR_MVR__c?12*e.MRR_MVR__c:null,vertical:t.length>0?t.join(", "):null,segment:e.Type||null,owner_name:e.Owner?.Name||null,customer_since:e.CreatedDate||null,facility_count:e.Locations__c||0,service_level:e.LevelOfService__c||null,managed_account:e.Managed_Account__c||null,cs_segment:e.VitallyClient_Success_Tier__c||null}}),{data:p,error:f}=await t.from("accounts").upsert(d,{onConflict:"user_id,salesforce_id",ignoreDuplicates:!1}).select();if(f)return o.Z.json({error:"Failed to store accounts",details:f.message},{status:500});await t.from("portfolios").delete().eq("user_id",r.id);let{data:g}=await t.from("accounts").select("id").eq("user_id",r.id).not("arr","is",null).order("arr",{ascending:!1}).limit(25);g&&g.length>0&&await t.from("portfolios").insert({user_id:r.id,name:"Top 25 by MRR",portfolio_type:"top_25",criteria:{type:"top_mrr",limit:25},account_ids:g.map(e=>e.id)});let{data:m}=await t.from("accounts").select("id").eq("user_id",r.id).eq("facility_count",1).not("arr","is",null).order("arr",{ascending:!1}).limit(50);m&&m.length>0&&await t.from("portfolios").insert({user_id:r.id,name:"Single Operator Index",portfolio_type:"single_operator",criteria:{type:"single_facility",limit:50},account_ids:m.map(e=>e.id)}),await t.from("integrations").update({last_synced_at:new Date().toISOString()}).eq("id",n.id);try{let t=e.headers.get("x-forwarded-proto")||"https",r=e.headers.get("host")||"friction-intelligence.vercel.app",n=`${t}://${r}/api/cron/analyze-portfolio`;fetch(n,{method:"GET",headers:{Authorization:`Bearer ${process.env.CRON_SECRET}`}}).catch(e=>console.error("Failed to trigger analysis:",e))}catch(e){console.error("Error triggering analysis:",e)}return o.Z.json({success:!0,synced:p?.length||0,portfolios:{top25:g?.length||0,singleOperator:m?.length||0},analyzing:!0,message:"Accounts synced! Friction analysis started in background."})}catch(e){return o.Z.json({error:"Sync failed",details:e instanceof Error?e.message:"Unknown"},{status:500})}}let d=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/salesforce/sync/route",pathname:"/api/salesforce/sync",filename:"route",bundlePath:"app/api/salesforce/sync/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/salesforce/sync/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:f,serverHooks:g,headerHooks:m,staticGenerationBailout:y}=d,h="/api/salesforce/sync/route";function v(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[456,552,421],()=>r(13655));module.exports=n})();