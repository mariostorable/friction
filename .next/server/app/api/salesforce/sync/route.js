"use strict";(()=>{var e={};e.id=638,e.ids=[638],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},13655:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>h,originalPathname:()=>k,patchFetch:()=>w,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>m});var n={};t.r(n),t.d(n,{POST:()=>d});var o=t(95419),s=t(69108),a=t(99678),i=t(78070),c=t(57699),l=t(23950),_=t(7439),u=t(5218);async function d(e){try{let r;let t=(0,c.createRouteHandlerClient)({cookies:_.cookies}),{data:{user:n}}=await t.auth.getUser();if(!n)return i.Z.json({error:"Not authenticated"},{status:401});let{data:o}=await t.from("integrations").select("*").eq("user_id",n.id).eq("integration_type","salesforce").eq("status","active").single();if(!o)return i.Z.json({error:"Salesforce not connected"},{status:400});let s=(0,l.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});try{r=await (0,u.fV)(s,o.id)}catch(e){return console.error("Failed to decrypt tokens:",e),i.Z.json({error:"Failed to access credentials",details:"Please reconnect Salesforce"},{status:500})}if(!r)return i.Z.json({error:"No tokens found"},{status:400});let a=async()=>{if(!r.refresh_token)throw Error("No refresh token available. Please reconnect Salesforce.");console.log("Refreshing Salesforce token...");let e=await fetch("https://storable.my.salesforce.com/services/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:r.refresh_token,client_id:process.env.SALESFORCE_CLIENT_ID,client_secret:process.env.SALESFORCE_CLIENT_SECRET})});if(!e.ok){let r=await e.text();throw console.error("Token refresh failed:",r),Error("Failed to refresh Salesforce token. Please reconnect Salesforce.")}let t=await e.json();return console.log("Token refreshed successfully"),await (0,u.au)(s,r.id,t.access_token,new Date(Date.now()+72e5).toISOString()),t.access_token},d=async e=>await fetch(`${o.instance_url}/services/data/v59.0/query?q=SELECT+Id,Name,MRR_MVR__c,Industry,Type,Owner.Name,CreatedDate,Current_FMS__c,Online_Listing_Service__c,Current_Website_Provider__c,Current_Payment_Provider__c,Insurance_Company__c,Gate_System__c,LevelOfService__c,Managed_Account__c,VitallyClient_Success_Tier__c,Locations__c,Corp_Code__c,SE_Company_UUID__c,SpareFoot_Client_Key__c,Insurance_ZCRM_ID__c,(SELECT+Id+FROM+Assets)+FROM+Account+WHERE+ParentId=null+AND+MRR_MVR__c>0+ORDER+BY+MRR_MVR__c+DESC+LIMIT+200`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),p=await d(r.access_token);if(401===p.status){console.log("Access token expired, refreshing...");try{let e=await a();p=await d(e)}catch(e){return i.Z.json({error:"Salesforce token expired",details:e instanceof Error?e.message:"Please reconnect Salesforce from Settings",needsReconnect:!0},{status:401})}}if(!p.ok){let e=await p.text();return i.Z.json({error:"Failed to fetch accounts",details:e},{status:500})}let f=await p.json();if(!f.records||0===f.records.length)return i.Z.json({message:"No accounts found",synced:0});let y=e=>{if(!e)return null;let r=e.toLowerCase();return r.includes("marine")||r.includes("marina")?"marine":r.includes("storage")||r.includes("self storage")?"storage":r.includes("rv")||r.includes("recreational vehicle")?"rv":"storage"},g=f.records.map(e=>{let r=y(e.Type),t=[];return"storage"===r&&(e.Corp_Code__c&&t.push("Software (SiteLink)"),e.SE_Company_UUID__c&&t.push("Software (EDGE)"),e.SpareFoot_Client_Key__c&&t.push("Marketplace (SpareFoot)"),e.Insurance_ZCRM_ID__c&&t.push("Insurance"),e.Current_FMS__c&&!t.some(r=>r.includes(e.Current_FMS__c))&&t.push(`Software (${e.Current_FMS__c})`),e.Online_Listing_Service__c&&!t.some(e=>e.includes("Marketplace"))&&t.push(`Marketplace (${e.Online_Listing_Service__c})`)),"marine"===r&&(e.Current_FMS__c&&t.push(`Software (${e.Current_FMS__c})`),e.Online_Listing_Service__c&&t.push(`Marketplace (${e.Online_Listing_Service__c})`)),e.Insurance_ZCRM_ID__c&&!t.includes("Insurance")&&t.push("Insurance"),e.Current_Website_Provider__c&&t.push(`Website (${e.Current_Website_Provider__c})`),e.Current_Payment_Provider__c&&t.push(`Payments (${e.Current_Payment_Provider__c})`),e.Insurance_Company__c&&!t.includes("Insurance")&&t.push(`Insurance (${e.Insurance_Company__c})`),e.Gate_System__c&&t.push(`Gate (${e.Gate_System__c})`),{user_id:n.id,salesforce_id:e.Id,name:e.Name,arr:e.MRR_MVR__c?12*e.MRR_MVR__c:null,vertical:r,products:t.length>0?t.join(", "):null,segment:e.Type||null,owner_name:e.Owner?.Name||null,customer_since:e.CreatedDate||null,facility_count:e.Locations__c||0,service_level:e.LevelOfService__c||null,managed_account:e.Managed_Account__c||null,cs_segment:e.VitallyClient_Success_Tier__c||null,metadata:{industry:e.Industry,type:e.Type,current_fms:e.Current_FMS__c}}}),{data:h,error:m}=await t.from("accounts").upsert(g,{onConflict:"user_id,salesforce_id",ignoreDuplicates:!1}).select();if(m)return i.Z.json({error:"Failed to store accounts",details:m.message},{status:500});await t.from("portfolios").delete().eq("user_id",n.id);let{data:k}=await t.from("accounts").select("id, vertical, products, arr").eq("user_id",n.id).eq("status","active").not("arr","is",null).order("arr",{ascending:!1}),w=k?.filter(e=>"storage"===e.vertical&&e.products&&(e.products.includes("EDGE")||e.products.includes("SiteLink"))).slice(0,25);w&&w.length>0&&await t.from("portfolios").insert({user_id:n.id,name:"Top 25 Storage Accounts",portfolio_type:"top_25_edge",criteria:{type:"top_mrr_storage",limit:25,vertical:"storage"},account_ids:w.map(e=>e.id)});let S=k?.filter(e=>"marine"===e.vertical).slice(0,25);S&&S.length>0&&await t.from("portfolios").insert({user_id:n.id,name:"Top 25 Marine Accounts",portfolio_type:"top_25_marine",criteria:{type:"top_mrr_marine",limit:25,vertical:"marine"},account_ids:S.map(e=>e.id)}),await t.from("integrations").update({last_synced_at:new Date().toISOString()}).eq("id",o.id);let E=null,C=null;try{let r=e.headers.get("x-forwarded-proto")||"https",t=e.headers.get("host")||"friction-intelligence.vercel.app",n=`${r}://${t}/api/cron/analyze-portfolio`;console.log("Triggering friction analysis at:",n);let o=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${process.env.CRON_SECRET}`},signal:AbortSignal.timeout(3e4)});if(o.ok)E=await o.json(),console.log("Analysis completed:",E);else{let e=await o.text();console.error("Analysis endpoint returned error:",o.status,e),C=`Analysis started but returned status ${o.status}`}}catch(e){console.error("Error triggering analysis:",e),C=e instanceof Error?e.message:"Unknown error",e instanceof Error&&"TimeoutError"===e.name&&(console.log("Analysis still running after 30s (expected for large portfolios)"),C=null)}let v=`Synced ${h?.length||0} accounts successfully!`;if(C)v+=`

⚠️ Warning: Analysis trigger failed - ${C}

You may need to manually trigger analysis from the dashboard or check Vercel logs.`;else if(E){let e=E.summary||{},r=e.analyzed||0,t=e.skipped||0,n=(w?.length||0)+(S?.length||0)-r-t;r>0&&(v+=`

✓ Analyzed ${r} account${r>1?"s":""}!`),t>0&&(v+=` ${t} already up to date.`),n>0&&(v+=` ${n} still pending (will process in next run).`)}else v+=`

Analysis is running in the background (processing up to 50 accounts). Check back in a few minutes.`;return i.Z.json({success:!0,synced:h?.length||0,portfolios:{storage:w?.length||0,marine:S?.length||0},analysisResult:E,analysisError:C,message:v})}catch(e){return i.Z.json({error:"Sync failed",details:e instanceof Error?e.message:"Unknown"},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/salesforce/sync/route",pathname:"/api/salesforce/sync",filename:"route",bundlePath:"app/api/salesforce/sync/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/salesforce/sync/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:y,serverHooks:g,headerHooks:h,staticGenerationBailout:m}=p,k="/api/salesforce/sync/route";function w(){return(0,a.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:y})}},5218:(e,r,t)=>{function n(){let e=process.env.ENCRYPTION_KEY;if(!e)throw Error("ENCRYPTION_KEY environment variable is not set. Generate one with: openssl rand -base64 32");if(e.length<32)throw Error("ENCRYPTION_KEY must be at least 32 characters for security. Current length: "+e.length);return e}async function o(e,r){let t=n();try{let{data:n,error:o}=await e.rpc("insert_encrypted_token",{p_integration_id:r.integration_id,p_access_token:r.access_token,p_refresh_token:r.refresh_token,p_token_type:r.token_type,p_expires_at:r.expires_at,p_encryption_key:t});if(o)throw console.error("Failed to upsert encrypted token:",o),Error(`Token encryption failed: ${o.message}`);if(!n)throw Error("Token insertion returned no ID");return console.log("Token stored successfully (encrypted)"),n}catch(e){throw console.error("Encryption error:",e),e}}async function s(e,r,t,o){let s=n();try{let{data:n,error:a}=await e.rpc("update_encrypted_token",{p_token_id:r,p_access_token:t,p_expires_at:o,p_encryption_key:s});if(a)throw console.error("Failed to update encrypted token:",a),Error(`Token update failed: ${a.message}`);if(!n)return console.warn("Token update returned false - token may not exist"),!1;return console.log("Token refreshed successfully (encrypted)"),n}catch(e){throw console.error("Token update error:",e),e}}async function a(e,r){let t=n();try{let{data:n,error:o}=await e.rpc("get_decrypted_token",{p_integration_id:r,p_encryption_key:t});if(o){if(console.error("Failed to fetch/decrypt token:",o),o.message.includes("decrypt")||o.message.includes("Wrong key"))throw Error("Token decryption failed - ENCRYPTION_KEY may be incorrect or changed. Verify the key matches what was used during encryption.");throw Error(`Token retrieval failed: ${o.message}`)}if(!n||Array.isArray(n)&&0===n.length)return console.warn(`No token found for integration: ${r}`),null;let s=Array.isArray(n)?n[0]:n;if(!s.access_token)throw Error("Decrypted token is missing access_token - data may be corrupted");return s}catch(e){throw console.error("Token decryption error:",e),e}}t.d(r,{au:()=>s,fV:()=>a,nu:()=>o})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[456,552,421],()=>t(13655));module.exports=n})();