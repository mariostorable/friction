"use strict";(()=>{var e={};e.id=215,e.ids=[215],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},64547:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>b,originalPathname:()=>x,patchFetch:()=>E,requestAsyncStorage:()=>m,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>k,staticGenerationBailout:()=>j});var s={};r.r(s),r.d(s,{POST:()=>g,maxDuration:()=>p});var n=r(95419),o=r(69108),i=r(99678),a=r(78070),l=r(57699),c=r(23950),u=r(7439),d=r(5218);let p=60,f={billing_confusion:["billing","invoice","payment","charge","subscription","pricing","refund","credit"],integration_failures:["integration","api","sync","connection","webhook","import","export","connector"],ui_confusion:["ui","interface","confusing","unclear","hard to find","navigation","usability","ux"],performance_issues:["slow","performance","loading","timeout","lag","speed","hanging","freeze"],missing_features:["feature request","missing","add","enhancement","capability","functionality"],training_gaps:["training","how to","tutorial","documentation","help","guide","learn"],support_response_time:["support","response","waiting","delayed","ticket","no reply"],data_quality:["data","incorrect","missing","wrong","inaccurate","corrupt","inconsistent"],reporting_issues:["report","dashboard","analytics","export","csv","excel","chart"],access_permissions:["access","permission","login","password","locked out","authentication","authorization"],configuration_problems:["configuration","settings","setup","config","preferences"],notification_issues:["notification","email","alert","reminder","message"],workflow_inefficiency:["workflow","process","manual","tedious","time consuming","inefficient"],mobile_issues:["mobile","app","ios","android","phone","tablet","responsive"]};async function g(e){try{let t,r;let s=e.headers.get("authorization"),n=e.headers.get("x-user-id");if(s===`Bearer ${process.env.CRON_SECRET}`&&n)t=n;else{let e=(0,l.createRouteHandlerClient)({cookies:u.cookies}),{data:{user:r}}=await e.auth.getUser();if(!r)return a.Z.json({error:"Not authenticated"},{status:401});t=r.id}let o=(0,c.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:i}=await o.from("integrations").select("*").eq("user_id",t).eq("integration_type","jira").eq("status","active").single();if(!i)return a.Z.json({error:"Jira not connected"},{status:400});try{r=await (0,d.fV)(o,i.id)}catch(e){return console.error("Failed to decrypt Jira token:",e),a.Z.json({error:"Failed to access credentials",details:"Please reconnect Jira"},{status:500})}if(!r)return a.Z.json({error:"No API token found. Please reconnect Jira."},{status:400});let p=i.metadata?.email,f=`Basic ${Buffer.from(`${p}:${r.access_token}`).toString("base64")}`,g="updated >= -90d ORDER BY updated DESC",y=0,h=[],m=0;console.log(`Fetching Jira issues with JQL: ${g}`);let k=!0;do{let e=await fetch(`${i.instance_url}/rest/api/3/search/jql?jql=${encodeURIComponent(g)}&startAt=${y}&maxResults=100&fields=summary,description,status,priority,assignee,labels,created,updated,resolutiondate,comment,sprint`,{headers:{Authorization:f,Accept:"application/json"}});if(!e.ok){let t=await e.text();return console.error("Jira API error:",t),a.Z.json({error:"Failed to fetch issues from Jira",details:t},{status:500})}let t=await e.json();console.log("Full Jira API response (first 500 chars):",JSON.stringify(t).substring(0,500)),console.log("All top-level keys:",Object.keys(t)),console.log("Looking for total in different fields:",{total:t.total,totalResults:t.totalResults,count:t.count,size:t.size,maxResults:t.maxResults,startAt:t.startAt,issuesLength:t.issues?.length}),m=t.total||t.totalResults||t.count||m;let r=t.issues?.length||0;r>0&&(h=h.concat(t.issues),console.log(`Fetched ${h.length} issues so far (got ${r} in this batch)`)),k=100===r,y+=100}while(k);if(console.log(`Finished fetching ${h.length} Jira issues`),0===m&&h.length>0&&(m=h.length),0===h.length)return a.Z.json({success:!0,synced:0,links_created:0,message:"No Jira issues found in the last 90 days"});let w=h.map(e=>({user_id:t,integration_id:i.id,jira_id:e.id,jira_key:e.key,summary:e.fields.summary,description:e.fields.description||"",status:e.fields.status?.name||"Unknown",priority:e.fields.priority?.name||null,assignee_name:e.fields.assignee?.displayName||null,assignee_email:e.fields.assignee?.emailAddress||null,sprint_name:e.fields.sprint?.name||null,labels:e.fields.labels||[],created_date:e.fields.created,updated_date:e.fields.updated,resolution_date:e.fields.resolutiondate||null,issue_url:`${i.instance_url}/browse/${e.key}`,metadata:{comment_count:e.fields.comment?.total||0,issue_type:e.fields.issuetype?.name||"Unknown"},last_synced_at:new Date().toISOString()})),{data:b,error:j}=await o.from("jira_issues").upsert(w,{onConflict:"user_id,jira_key",ignoreDuplicates:!1}).select();if(j)return console.error("Insert error:",j),a.Z.json({error:"Failed to store Jira issues",details:j.message},{status:500});console.log(`Stored ${b?.length||0} Jira issues`);let x=0;for(let e of b||[]){let r=await _(o,t,e);x+=r.length}return await o.from("integrations").update({last_synced_at:new Date().toISOString()}).eq("id",i.id),console.log(`Sync complete: ${b?.length} issues, ${x} theme links created`),a.Z.json({success:!0,synced:b?.length||0,total_available:m,links_created:x,message:`Synced ${b?.length} of ${m} total issues available`})}catch(e){return console.error("Jira sync error:",e),a.Z.json({error:"Jira sync failed",details:e instanceof Error?e.message:"Unknown"},{status:500})}}async function _(e,t,r){let s=[],n=`${r.summary} ${r.description||""}`.toLowerCase();for(let n of r.labels||[]){let o=n.toLowerCase().replace(/[_-\s]/g,"_");f[o]&&(await y(e,t,r.id,o,"label",1),s.push(o))}for(let[o,i]of Object.entries(f)){if(s.includes(o))continue;let a=i.filter(e=>n.includes(e.toLowerCase())).length;a>=2?(await y(e,t,r.id,o,"keyword",.8),s.push(o)):1===a&&(await y(e,t,r.id,o,"keyword",.5),s.push(o))}return s}async function y(e,t,r,s,n,o){try{await e.from("theme_jira_links").upsert({user_id:t,jira_issue_id:r,theme_key:s,match_type:n,match_confidence:o},{onConflict:"jira_issue_id,theme_key",ignoreDuplicates:!0})}catch(e){console.error(`Failed to create theme link for ${s}:`,e)}}let h=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/jira/sync/route",pathname:"/api/jira/sync",filename:"route",bundlePath:"app/api/jira/sync/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/jira/sync/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:k,serverHooks:w,headerHooks:b,staticGenerationBailout:j}=h,x="/api/jira/sync/route";function E(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:k})}},5218:(e,t,r)=>{function s(){let e=process.env.ENCRYPTION_KEY;if(!e)throw Error("ENCRYPTION_KEY environment variable is not set. Generate one with: openssl rand -base64 32");if(e.length<32)throw Error("ENCRYPTION_KEY must be at least 32 characters for security. Current length: "+e.length);return e}async function n(e,t){let r=s();try{let{data:s,error:n}=await e.rpc("insert_encrypted_token",{p_integration_id:t.integration_id,p_access_token:t.access_token,p_refresh_token:t.refresh_token,p_token_type:t.token_type,p_expires_at:t.expires_at,p_encryption_key:r});if(n)throw console.error("Failed to upsert encrypted token:",n),Error(`Token encryption failed: ${n.message}`);if(!s)throw Error("Token insertion returned no ID");return console.log("Token stored successfully (encrypted)"),s}catch(e){throw console.error("Encryption error:",e),e}}async function o(e,t,r,n){let o=s();try{let{data:s,error:i}=await e.rpc("update_encrypted_token",{p_token_id:t,p_access_token:r,p_expires_at:n,p_encryption_key:o});if(i)throw console.error("Failed to update encrypted token:",i),Error(`Token update failed: ${i.message}`);if(!s)return console.warn("Token update returned false - token may not exist"),!1;return console.log("Token refreshed successfully (encrypted)"),s}catch(e){throw console.error("Token update error:",e),e}}async function i(e,t){let r=s();try{let{data:s,error:n}=await e.rpc("get_decrypted_token",{p_integration_id:t,p_encryption_key:r});if(n){if(console.error("Failed to fetch/decrypt token:",n),n.message.includes("decrypt")||n.message.includes("Wrong key"))throw Error("Token decryption failed - ENCRYPTION_KEY may be incorrect or changed. Verify the key matches what was used during encryption.");throw Error(`Token retrieval failed: ${n.message}`)}if(!s||Array.isArray(s)&&0===s.length)return console.warn(`No token found for integration: ${t}`),null;let o=Array.isArray(s)?s[0]:s;if(!o.access_token)throw Error("Decrypted token is missing access_token - data may be corrupted");return o}catch(e){throw console.error("Token decryption error:",e),e}}r.d(t,{au:()=>o,fV:()=>i,nu:()=>n})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[456,552,421],()=>r(64547));module.exports=s})();