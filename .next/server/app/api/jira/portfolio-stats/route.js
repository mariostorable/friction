"use strict";(()=>{var e={};e.id=294,e.ids=[294],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},47870:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>f,originalPathname:()=>y,patchFetch:()=>g,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>h});var s={};r.r(s),r.d(s,{GET:()=>l});var o=r(95419),a=r(69108),i=r(99678),n=r(78070),c=r(57699),u=r(7439);async function l(e){try{let e=(0,c.createRouteHandlerClient)({cookies:u.cookies}),{data:{user:t}}=await e.auth.getUser();if(!t)return n.Z.json({error:"Not authenticated"},{status:401});let{data:r}=await e.from("friction_cards").select("theme_key, severity, account_id, accounts(name, arr)").eq("user_id",t.id);if(!r||0===r.length)return n.Z.json({portfolio:{resolved_7d:0,resolved_30d:0,resolved_90d:0,in_progress:0,open:0},topThemes:[],accountsByIssue:[],accountTicketCounts:{}});let s={};r.forEach(e=>{let t=e.theme_key;s[t]||(s[t]={count:0,avgSeverity:0,weight:0,accounts:new Set}),s[t].count++,s[t].avgSeverity+=e.severity||3,s[t].accounts.add(e.account_id)}),Object.keys(s).forEach(e=>{let t=s[e];t.avgSeverity=t.avgSeverity/t.count,t.weight=t.count*t.avgSeverity});let o=Object.keys(s),{data:a}=await e.from("theme_jira_links").select(`
        theme_key,
        match_confidence,
        jira_issues!inner(
          id,
          jira_key,
          summary,
          status,
          priority,
          resolution_date,
          updated_date,
          issue_url
        )
      `).in("theme_key",o).eq("jira_issues.user_id",t.id),i=new Date,l=new Date(i.getTime()-6048e5),d=new Date(i.getTime()-2592e6),p=new Date(i.getTime()-7776e6),_=0,m=0,f=0,h=0,y=0,g={};a?.forEach(e=>{let t=e.jira_issues,r=e.theme_key;if(g[r]||(g[r]=[]),g[r].push(t),t.resolution_date){let e=new Date(t.resolution_date);e>=l&&_++,e>=d&&m++,e>=p&&f++}else{let e=t.status?.toLowerCase()||"";e.includes("progress")||e.includes("development")||e.includes("review")?h++:y++}});let v=Object.entries(s).filter(([e])=>g[e]?.length>0).map(([e,t])=>({theme_key:e,case_count:t.count,account_count:t.accounts.size,avg_severity:t.avgSeverity,ticket_count:g[e]?.length||0,tickets:g[e]||[]})).sort((e,t)=>t.account_count-e.account_count).slice(0,10),j={};r.forEach(e=>{(g[e.theme_key]||[]).forEach(t=>{j[t.jira_key]||(j[t.jira_key]=new Set),j[t.jira_key].add(e.account_id)})});let k=Object.entries(j).filter(([e,t])=>t.size>=2).map(([e,t])=>{let s=a?.find(t=>t.jira_issues?.jira_key===e)?.jira_issues,o=Array.from(t).map(e=>{let t=r.find(t=>t.account_id===e),s=t?.accounts;return{id:e,name:s?.name||"Unknown",arr:s?.arr||0}});return{jira_key:e,summary:s?.summary||"",status:s?.status||"Unknown",issue_url:s?.issue_url||"#",affected_accounts:o,impact_score:o.reduce((e,t)=>e+(t.arr||0),0)}}).sort((e,t)=>t.impact_score-e.impact_score).slice(0,20),w={};return r.forEach(e=>{let t=e.account_id;w[t]||(w[t]={resolved_7d:0,in_progress:0,open:0}),(g[e.theme_key]||[]).forEach(e=>{if(e.resolution_date)new Date(e.resolution_date)>=l&&w[t].resolved_7d++;else{let r=e.status?.toLowerCase()||"";r.includes("progress")||r.includes("development")?w[t].in_progress++:w[t].open++}})}),n.Z.json({portfolio:{resolved_7d:_,resolved_30d:m,resolved_90d:f,in_progress:h,open:y},topThemes:v,accountsByIssue:k,accountTicketCounts:w})}catch(e){return console.error("Error fetching portfolio Jira stats:",e),n.Z.json({error:"Failed to fetch portfolio stats",details:e instanceof Error?e.message:"Unknown"},{status:500})}}let d=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/jira/portfolio-stats/route",pathname:"/api/jira/portfolio-stats",filename:"route",bundlePath:"app/api/jira/portfolio-stats/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/jira/portfolio-stats/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:_,serverHooks:m,headerHooks:f,staticGenerationBailout:h}=d,y="/api/jira/portfolio-stats/route";function g(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:_})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[456,552,421],()=>r(47870));module.exports=s})();