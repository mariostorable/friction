"use strict";(()=>{var e={};e.id=144,e.ids=[144],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},66303:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>m,patchFetch:()=>w,requestAsyncStorage:()=>y,routeModule:()=>_,serverHooks:()=>k,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>g});var n={};r.r(n),r.d(n,{POST:()=>p});var o=r(95419),a=r(69108),i=r(99678),s=r(78070),c=r(57699),l=r(23950),u=r(7439),d=r(5218);async function p(e){try{let t=(0,c.createRouteHandlerClient)({cookies:u.cookies}),{data:{user:r}}=await t.auth.getUser();if(!r)return s.Z.json({error:"Not authenticated"},{status:401});let{jiraUrl:n,email:o,apiToken:a}=await e.json();if(!n||!o||!a)return s.Z.json({error:"Missing required fields. Please provide Jira URL, email, and API token."},{status:400});let i=n.replace(/^https?:\/\//,"").replace(/\/$/,""),p=`https://${i}`,_=await fetch(`${p}/rest/api/3/myself`,{headers:{Authorization:`Basic ${Buffer.from(`${o}:${a}`).toString("base64")}`,Accept:"application/json"}});if(!_.ok){let e=await _.text();return console.error("Jira connection test failed:",e),s.Z.json({error:"Failed to connect to Jira. Please check your URL, email, and API token.",details:e},{status:400})}let y=await _.json();console.log("Jira connection successful:",y.displayName);let{data:f,error:k}=await t.from("integrations").upsert({user_id:r.id,integration_type:"jira",status:"active",instance_url:p,metadata:{email:o,jira_user_name:y.displayName,jira_account_id:y.accountId},connected_at:new Date().toISOString()},{onConflict:"user_id,integration_type",ignoreDuplicates:!1}).select().single();if(k)throw console.error("Integration storage error:",k),k;let h=(0,l.eI)("https://skoknvludvonitgekwno.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});try{let e=await (0,d.nu)(h,{integration_id:f.id,access_token:a,refresh_token:null,token_type:"api_token",expires_at:null});console.log("Jira integration and encrypted token stored successfully:",e)}catch(e){throw console.error("Failed to store encrypted API token:",e),Error(`Token storage failed: ${e instanceof Error?e.message:"Unknown error"}`)}return s.Z.json({success:!0,integration:{id:f.id,instance_url:f.instance_url,connected_at:f.connected_at}})}catch(e){return console.error("Jira connection error:",e),s.Z.json({error:"Failed to connect to Jira",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/jira/connect/route",pathname:"/api/jira/connect",filename:"route",bundlePath:"app/api/jira/connect/route"},resolvedPagePath:"/Users/mario/friction-intelligence/app/api/jira/connect/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:y,staticGenerationAsyncStorage:f,serverHooks:k,headerHooks:h,staticGenerationBailout:g}=_,m="/api/jira/connect/route";function w(){return(0,i.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:f})}},5218:(e,t,r)=>{function n(){let e=process.env.ENCRYPTION_KEY;if(!e)throw Error("ENCRYPTION_KEY environment variable is not set. Generate one with: openssl rand -base64 32");if(e.length<32)throw Error("ENCRYPTION_KEY must be at least 32 characters for security. Current length: "+e.length);return e}async function o(e,t){let r=n();try{let{data:n,error:o}=await e.rpc("insert_encrypted_token",{p_integration_id:t.integration_id,p_access_token:t.access_token,p_refresh_token:t.refresh_token,p_token_type:t.token_type,p_expires_at:t.expires_at,p_encryption_key:r});if(o)throw console.error("Failed to upsert encrypted token:",o),Error(`Token encryption failed: ${o.message}`);if(!n)throw Error("Token insertion returned no ID");return console.log("Token stored successfully (encrypted)"),n}catch(e){throw console.error("Encryption error:",e),e}}async function a(e,t,r,o){let a=n();try{let{data:n,error:i}=await e.rpc("update_encrypted_token",{p_token_id:t,p_access_token:r,p_expires_at:o,p_encryption_key:a});if(i)throw console.error("Failed to update encrypted token:",i),Error(`Token update failed: ${i.message}`);if(!n)return console.warn("Token update returned false - token may not exist"),!1;return console.log("Token refreshed successfully (encrypted)"),n}catch(e){throw console.error("Token update error:",e),e}}async function i(e,t){let r=n();try{let{data:n,error:o}=await e.rpc("get_decrypted_token",{p_integration_id:t,p_encryption_key:r});if(o){if(console.error("Failed to fetch/decrypt token:",o),o.message.includes("decrypt")||o.message.includes("Wrong key"))throw Error("Token decryption failed - ENCRYPTION_KEY may be incorrect or changed. Verify the key matches what was used during encryption.");throw Error(`Token retrieval failed: ${o.message}`)}if(!n||Array.isArray(n)&&0===n.length)return console.warn(`No token found for integration: ${t}`),null;let a=Array.isArray(n)?n[0]:n;if(!a.access_token)throw Error("Decrypted token is missing access_token - data may be corrupted");return a}catch(e){throw console.error("Token decryption error:",e),e}}r.d(t,{au:()=>a,fV:()=>i,nu:()=>o})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[456,552,421],()=>r(66303));module.exports=n})();